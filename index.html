<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>오늘의 날씨</title>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <style>
        :root {
            /* 화이트 모드 색상 변수 */
            --bg-color: #f4f7f6; /* 매우 밝은 회색 배경 */
            --card-bg-color: #ffffff; /* 카드 배경 (흰색) */
            --border-color: #e0e0e0; /* 연한 회색 테두리 */
            --primary-text-color: #2c3e50; /* 어두운 네이비 텍스트 */
            --secondary-text-color: #7f8c8d; /* 중간 회색 텍스트 */
            --accent-color: #3498db; /* 포인트 색상 (파랑) */
            --accent-color-warm: #e67e22; /* 따뜻한 느낌 포인트 (주황) */
            --accent-color-cold: #3498db; /* 차가운 느낌 포인트 (파랑) */
            --rain-color: #3498db;
            --snow-color: #5dade2; /* 눈 색상 약간 변경 */
            --font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; /* 한국어 폰트 우선 */
            --skeleton-bg: #e9ecef;
            --skeleton-shine: rgba(0, 0, 0, 0.04);
            --shadow-color: rgba(0, 0, 0, 0.08);
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--primary-text-color);
            margin: 0;
            padding: 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
            opacity: 0;
            animation: fadeInPage 0.8s 0.2s ease-out forwards;
        }

        @keyframes fadeInPage {
            to { opacity: 1; }
        }

        canvas#weather-effects-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1; pointer-events: none;
        }

        .cloud-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -2; pointer-events: none; overflow: hidden;
            opacity: 0.5;
        }
        .cloud {
            position: absolute;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 100 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M77.5,60 C77.5,60 77.5,60 77.53,60 C81.03,60 84.19,58.82 86.65,56.78 C92.03,52.28 93.19,44.54 89.44,38.46 C89.07,37.88 88.66,37.33 88.22,36.81 C88.63,36.22 89,35.59 89.3,34.92 C92.8,28.14 90.29,19.91 83.94,15.83 C82.03,14.75 79.88,14.2 77.68,14.2 C76.32,14.2 75,14.42 73.79,14.85 C71.73,10.63 67.03,7.6 61.66,7.6 C55.03,7.6 49.53,11.94 47.87,17.91 C46.07,17.17 44.07,16.8 41.97,16.8 C34.22,16.8 27.92,22.2 27.07,29.67 C26.97,29.67 26.87,29.68 26.78,29.68 C22.03,29.68 18.13,32.81 16.73,37.01 C12.53,38.06 9.63,41.89 9.63,46.4 C9.63,51.93 14.01,56.3 19.53,56.3 L19.53,56.3 L72.38,56.3 C72.38,56.3 72.38,56.3 72.38,56.3S77.5,60 77.5,60Z' fill='%23000' fill-opacity='0.05'/%3E%3C/svg%3E");
            background-repeat: repeat-x;
            background-size: 250px auto; 
            width: 300%; height: 120px;
            animation: moveClouds 80s linear infinite;
        }
        .cloud.cloud1 { top: 2%; animation-duration: 90s; }
        .cloud.cloud2 { top: 10%; animation-duration: 70s; animation-delay: -15s; opacity: 0.7; background-size: 300px auto; }
        .cloud.cloud3 { top: 18%; animation-duration: 100s; opacity: 0.8; background-size: 200px auto; }

        @keyframes moveClouds {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100vw); }
        }

        .container { width: 100%; max-width: 1500px; }
        header { text-align: center; margin-bottom: 35px; }
        header h1 { font-size: 3em; font-weight: 300; color: var(--primary-text-color); margin-bottom: 10px; }
        header p { font-size: 1.25em; color: var(--secondary-text-color); }

        /* 스켈레톤 UI */
        .skeleton { background-color: var(--skeleton-bg); border-radius: 10px; position: relative; overflow: hidden; }
        .skeleton::before { background: linear-gradient(to right, transparent 0%, var(--skeleton-shine) 50%, transparent 100%); animation: skeletonShine 1.6s infinite; content: ""; position: absolute; top: 0; left: -150%; width: 100%; height: 100%;}
        @keyframes skeletonShine { 0% { left: -150%; } 100% { left: 150%; } }
        .skeleton-text { height: 1.2em; margin-bottom: 0.6em; border-radius: 4px; }
        .skeleton-icon { width: 5em; height: 5em; border-radius: 50%; margin: 0 auto; }

        .top-info-grid { display: grid; grid-template-columns: 1fr; gap: 25px; margin-bottom: 35px; }

        .current-weather-section, .aqi-section {
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
            border-radius: 16px; 
            padding: 30px;
            box-shadow: 0 6px 20px var(--shadow-color);
        }
        .current-weather-section h2, .aqi-section h2 {
            font-size: 1.6em; font-weight: 600; color: var(--primary-text-color);
            margin-top: 0; margin-bottom: 25px; border-bottom: 1px solid var(--border-color); padding-bottom: 12px;
            display: flex; align-items: center;
        }
        .current-weather-section h2::before { content: "🌦️"; margin-right: 10px; font-size: 1.2em;}
        .aqi-section h2::before { content: "🌬️"; margin-right: 10px; font-size: 1.2em;}

        .current-weather-main { display: flex; align-items: center; gap: 30px; margin-bottom: 25px; }
        .current-weather-main .icon { font-size: 6em; line-height: 1; animation: gentleRotate 20s linear infinite paused; filter: drop-shadow(2px 2px 3px rgba(0,0,0,0.1));}
        .current-weather-main .icon.sun { animation-play-state: running; }
        @keyframes gentleRotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .current-weather-main .temp-desc .temp { font-size: 4.5em; font-weight: 700; color: var(--primary-text-color); }
        .current-weather-main .temp-desc .desc { font-size: 1.4em; color: var(--secondary-text-color); text-transform: capitalize; margin-top: 5px; }

        .current-weather-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 18px; }
        .current-weather-details div { color: var(--secondary-text-color); font-size: 1em; background-color: #f9f9f9; padding: 10px 12px; border-radius: 8px; border: 1px solid #eee;}
        .current-weather-details div strong { color: var(--primary-text-color); font-weight: 600; }
        .current-weather-details div::before { margin-right: 8px; }
        .current-weather-details div:nth-child(1)::before { content: "🌡️"; } /* 체감 */
        .current-weather-details div:nth-child(2)::before { content: "💧"; } /* 습도 */
        .current-weather-details div:nth-child(3)::before { content: "💨"; } /* 풍속 */
        .current-weather-details div:nth-child(4)::before { content: "🧭"; } /* 풍향 */
        .current-weather-details div:nth-child(5)::before { content: "☔"; } /* 강수 */
        .current-weather-details div:nth-child(6)::before { content: "⏰"; } /* 시간 */

        .aqi-section { display: none; }
        /* AQI 관련 스타일은 유지하되, 섹션 자체는 숨김 */

        .weekly-temp-chart-container {
             background-color: var(--card-bg-color); border: 1px solid var(--border-color);
             border-radius: 16px; padding: 25px; margin-bottom: 35px;
             height: 380px; 
             position: relative;
             box-shadow: 0 6px 20px var(--shadow-color);
        }
        .weekly-temp-chart-container h2 {
            font-size: 1.6em; font-weight: 600; margin-top:0; margin-bottom: 20px; text-align: center;
            display: flex; align-items: center; justify-content: center;
        }
        .weekly-temp-chart-container h2::before { content: "📊"; margin-right: 10px; font-size: 1.1em;}

        #weeklyTempChart { max-height: calc(100% - 50px); }

        /* 주간 예보 컨테이너 */
        .forecast-container { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(310px, 1fr)); 
            gap: 30px; 
            width: 100%; /* ⭐ 너비 명시 */
        }

        .weather-card {
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
            border-radius: 16px; padding: 25px;
            box-shadow: 0 6px 15px var(--shadow-color);
            display: flex; flex-direction: column; gap: 18px;
            cursor: pointer;
            /* ⭐ 애니메이션 적용 확인: opacity와 transform 초기값 */
            opacity: 0; 
            transform: translateY(25px);
            /* ⭐ animation 속성 확인 */
            animation: cardFadeInUp 0.6s ease-out forwards; 
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }
        /* ⭐ 각 카드별 animation-delay 적용 확인 */
        .weather-card:nth-child(1) { animation-delay: 0.15s; }
        .weather-card:nth-child(2) { animation-delay: 0.25s; }
        .weather-card:nth-child(3) { animation-delay: 0.35s; }
        .weather-card:nth-child(4) { animation-delay: 0.45s; }
        .weather-card:nth-child(5) { animation-delay: 0.55s; }
        .weather-card:nth-child(6) { animation-delay: 0.65s; }
        .weather-card:nth-child(7) { animation-delay: 0.75s; }


        @keyframes cardFadeInUp {
            to { opacity: 1; transform: translateY(0); }
        }

        .weather-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.12);
        }

        .card-header { text-align: center; border-bottom: 1px solid var(--border-color); padding-bottom: 12px; }
        .card-header .day-name { font-size: 1.5em; font-weight: 700; color: var(--primary-text-color); }
        .card-header .month-day { font-size: 0.95em; color: var(--secondary-text-color); margin-top: 3px; }

        .card-main-weather { display: flex; align-items: center; justify-content: space-between; gap: 20px; }
        .card-main-weather .icon { font-size: 4.5em; animation: gentleBob 3s ease-in-out infinite alternate; filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.08));}
        @keyframes gentleBob { from { transform: translateY(0); } to { transform: translateY(-5px); } }

        .card-main-weather .temps { text-align: right; }
        .card-main-weather .temps .temp-range { font-size: 1.3em; display: block; margin-bottom: 6px; font-weight: 500; }
        .card-main-weather .temps .temp-min { color: var(--accent-color-cold); font-weight: 700; }
        .card-main-weather .temps .temp-max { color: var(--accent-color-warm); font-weight: 700; }
        .card-main-weather .weather-description { font-size: 1.15em; color: var(--secondary-text-color); text-transform: capitalize; margin-top: 4px; }

        .card-details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 0.95em; }
        .detail-item { background-color: #f9f9f9; padding: 12px; border-radius: 10px; border: 1px solid #eee; color: var(--secondary-text-color); display:flex; flex-direction: column; }
        .detail-item .label { display: block; font-size: 0.9em; margin-bottom: 5px; color: var(--primary-text-color); opacity: 0.9; }
        .detail-item .value { font-weight: 600; color: var(--primary-text-color); }
        .detail-item .value .unit { font-size: 0.9em; opacity: 0.8; margin-left: 4px; }
        /* 상세 아이템 이모지 */
        .detail-item.feels-like::before { content: "🌡️"; margin-right: 6px; font-size: 0.9em; align-self: flex-start; }
        .detail-item.precipitation::before { content: "💧"; margin-right: 6px; font-size: 0.9em; align-self: flex-start; }
        .detail-item.wind::before { content: "💨"; margin-right: 6px; font-size: 0.9em; align-self: flex-start; }
        .detail-item.uv-index::before { content: "☀️"; margin-right: 6px; font-size: 0.9em; align-self: flex-start; } /* UV는 태양 */
        .detail-item.sunrise-sunset::before { content: "🌅"; margin-right: 6px; font-size: 0.9em; align-self: flex-start; }
        .detail-item.precipitation-hours::before { content: "⏳"; margin-right: 6px; font-size: 0.9em; align-self: flex-start; }

        /* 모달 스타일 */
        .modal {
            display: none; position: fixed; z-index: 1000;
            left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(40, 40, 60, 0.6);
            opacity: 0; transition: opacity 0.3s ease-out;
        }
        .modal.active { display: flex; opacity: 1; }
        .modal-content {
            background-color: var(--card-bg-color); color: var(--primary-text-color);
            margin: auto; padding: 35px; border: 1px solid var(--border-color);
            border-radius: 16px; width: 90%; max-width: 750px;
            box-shadow: 0 12px 35px rgba(0,0,0,0.15);
            transform: scale(0.95); transition: transform 0.3s ease-out;
            display: flex; flex-direction: column;
        }
        .modal.active .modal-content { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 18px; margin-bottom: 25px; flex-shrink: 0; }
        .modal-header h2 { font-size: 1.8em; margin: 0; color: var(--primary-text-color); font-weight: 600; }
        .close-button { color: var(--secondary-text-color); font-size: 2.2em; font-weight: bold; cursor: pointer; border:none; background: none; line-height: 1; }
        .close-button:hover, .close-button:focus { color: var(--primary-text-color); }
        .hourly-forecast-list { 
            overflow-y: auto; padding-right: 15px; 
            flex-grow: 1;
            min-height: 180px;
            margin-bottom: 20px; /* 차트와의 간격 */
        }
        .hourly-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 5px; border-bottom: 1px solid #f0f0f0; }
        .hourly-item:last-child { border-bottom: none; }
        .hourly-item .time { font-weight: 600; width: 22%; }
        .hourly-item .icon { font-size: 2em; width: 18%; text-align: center; }
        .hourly-item .temp { width: 20%; text-align: right; font-weight: 500; }
        .hourly-item .precip { width: 25%; text-align: right; font-size: 0.95em; }
        .hourly-item .desc { width: 15%; text-align: right; font-size: 0.9em; color: var(--secondary-text-color); text-transform: capitalize;}
        
        .hourly-chart-wrapper {
            height: 320px; 
            position: relative;
            flex-shrink: 0;
        }
        #hourlyTempChart { max-height: 100%; }

        #error { font-size: 1.3em; text-align: center; margin-top: 50px; width: 100%; color: #c0392b; }
        #error span { font-size: 1.8em; display: block; margin-bottom: 10px; }

        /* 로딩 스켈레톤 */
        #loadingSkeleton { width: 100%; max-width: 1500px; }
        .skeleton-current-weather-section, .skeleton-aqi-section { background-color: var(--card-bg-color); border: 1px solid var(--border-color); border-radius: 16px; padding: 30px; box-shadow: 0 6px 20px var(--shadow-color); }
        .skeleton-current-weather-main { display: flex; align-items: center; gap: 30px; margin-bottom: 25px; }
        .skeleton-current-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 18px; }
        .skeleton-forecast-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(310px, 1fr)); gap: 30px; }
        .skeleton-card { background-color: var(--card-bg-color); border: 1px solid var(--border-color); border-radius: 16px; padding: 25px; }

        @media (max-width: 768px) {
            body { padding: 15px; }
            header h1 { font-size: 2.4em; }
            header p { font-size: 1.1em; }
            .current-weather-main .icon { font-size: 5em; }
            .current-weather-main .temp-desc .temp { font-size: 3.5em; }
            .forecast-container, .skeleton-forecast-container { grid-template-columns: 1fr; }
            .modal-content { width: 95%; padding: 25px; max-height: 85vh; }
            .hourly-chart-wrapper { height: 280px; }
            .hourly-item .time { width: 25%; }
            .hourly-item .icon { width: 20%; }
            .hourly-item .temp { width: 25%; }
            .hourly-item .precip { display: none; }
            .hourly-item .desc { width: 30%; }
        }
    </style>
</head>
<body>
    <div class="cloud-overlay">
        <div class="cloud cloud1"></div>
        <div class="cloud cloud2"></div>
        <div class="cloud cloud3"></div>
    </div>
    <canvas id="weather-effects-canvas"></canvas>

    <div id="loadingSkeleton">
        <header>
            <div class="skeleton skeleton-text" style="width: 40%; height: 2.8em; margin: 0 auto 8px;"></div>
            <div class="skeleton skeleton-text" style="width: 60%; height: 1.2em; margin: 0 auto;"></div>
        </header>
        <div class="top-info-grid">
            <section class="skeleton-current-weather-section">
                <div class="skeleton skeleton-text" style="width: 30%; height: 1.4em; margin-bottom: 20px;"></div>
                <div class="skeleton-current-weather-main">
                    <div class="skeleton skeleton-icon" style="width: 5.5em; height: 5.5em;"></div>
                    <div>
                        <div class="skeleton skeleton-text" style="width: 100px; height: 4em;"></div>
                        <div class="skeleton skeleton-text" style="width: 150px; height: 1.3em; margin-top: 5px;"></div>
                    </div>
                </div>
                <div class="skeleton-current-details">
                    <div class="skeleton skeleton-text" style="height: 2.5em;"></div> <div class="skeleton skeleton-text" style="height: 2.5em;"></div>
                    <div class="skeleton skeleton-text" style="height: 2.5em;"></div> <div class="skeleton skeleton-text" style="height: 2.5em;"></div>
                </div>
            </section>
        </div>
        <div class="weekly-temp-chart-container skeleton" style="height: 380px; margin-bottom: 35px;">
             <div class="skeleton skeleton-text" style="width: 50%; height: 1.6em; margin: 0 auto 20px;"></div>
        </div>
        <main class="skeleton-forecast-container">
            <div class="skeleton-card" style="height: 320px;"></div> <div class="skeleton-card" style="height: 320px;"></div> <div class="skeleton-card" style="height: 320px;"></div>
        </main>
    </div>

    <div class="container" id="appContainer" style="display:none;">
        <header>
            <h1 id="mainTitle">오늘과 주간 날씨</h1>
            <p id="subTitle">서울의 상세한 날씨 정보를 확인하세요.</p>
        </header>

        <div class="top-info-grid">
            <section class="current-weather-section">
                <h2>현재 날씨</h2>
                <div class="current-weather-main">
                    <span class="icon" id="currentWeatherIcon"></span>
                    <div class="temp-desc">
                        <span class="temp" id="currentTemp"></span>
                        <span class="desc" id="currentWeatherDesc"></span>
                    </div>
                </div>
                <div class="current-weather-details">
                    <div>체감: <strong id="currentApparentTemp"></strong></div>
                    <div>습도: <strong id="currentHumidity"></strong></div>
                    <div>풍속: <strong id="currentWindSpeed"></strong></div>
                    <div>풍향: <strong id="currentWindDir"></strong></div>
                    <div>강수(1h): <strong id="currentPrecipitation"></strong></div>
                    <div>시간: <strong id="currentTime"></strong></div>
                </div>
            </section>
             <!-- AQI 섹션은 display: none 처리됨 -->
             <section class="aqi-section" id="aqiSection" style="display: none;">
                 <h2>대기 질 지수 (AQI)</h2>
                 <div class="aqi-details">
                     <div class="aqi-value" id="aqiValue">N/A</div>
                     <div class="aqi-level" id="aqiLevel">정보 없음</div>
                     <div class="aqi-pollutants">
                         <span>(정보 로딩 중...)</span>
                     </div>
                 </div>
             </section>
        </div>
        
        <section class="weekly-temp-chart-container">
            <h2>주간 최고/최저 기온</h2>
            <canvas id="weeklyTempChart"></canvas>
        </section>

        <main class="forecast-container" id="forecastContainer">
            <!-- 날씨 카드가 여기에 동적으로 추가됩니다. -->
        </main>
    </div>

    <!-- 시간별 예보 모달 -->
    <div id="hourlyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">시간별 예보</h2>
                <span class="close-button" id="closeModalButton">&times;</span>
            </div>
            <div class="hourly-forecast-list" id="hourlyForecastList">
                <!-- 시간별 예보 아이템이 여기에 동적으로 추가됩니다. -->
            </div>
            <div class="hourly-chart-wrapper"> 
                 <canvas id="hourlyTempChart"></canvas>
            </div>
        </div>
    </div>

    <div id="error" style="display:none;"><span>⚠️</span>날씨 정보를 가져오는데 실패했습니다. 나중에 다시 시도해주세요.</div>

<script>
    const SEOUL_LAT = 37.5665;
    const SEOUL_LON = 126.9780;

    const appContainer = document.getElementById('appContainer');
    const loadingSkeleton = document.getElementById('loadingSkeleton');
    const forecastContainer = document.getElementById('forecastContainer');
    const errorMessage = document.getElementById('error');
    const canvas = document.getElementById('weather-effects-canvas');
    const ctx = canvas.getContext('2d');
    let animationFrameId;
    let particles = [];
    let currentEffectType = null;

    const hourlyModal = document.getElementById('hourlyModal');
    const closeModalButton = document.getElementById('closeModalButton');
    const hourlyForecastList = document.getElementById('hourlyForecastList');
    const modalTitle = document.getElementById('modalTitle');
    let weeklyTempChartInstance = null;
    let hourlyTempChartInstance = null;
    const aqiSectionEl = document.getElementById('aqiSection'); 

    // Chart.js 전역 기본값 설정 (화이트 모드 텍스트 색상)
    Chart.defaults.color = 'var(--primary-text-color)'; // 기본 텍스트 색상
    Chart.defaults.borderColor = 'var(--border-color)'; // 기본 테두리/그리드 색상


    function getWeatherDetails(wmoCode, isDay = true) { /* ... (이전과 동일) ... */ const wmoMap={0:{description:"맑음",icon:isDay?"☀️":"🌙",effect:null},1:{description:"대체로 맑음",icon:isDay?"🌤️":"☁️🌙",effect:null},2:{description:"부분적 흐림",icon:isDay?"🌥️":"☁️",effect:null},3:{description:"흐림",icon:"☁️",effect:null},45:{description:"안개",icon:"🌫️",effect:null},48:{description:"서리 안개",icon:"🌫️❄️",effect:null},51:{description:"가벼운 이슬비",icon:"💧",effect:"rain"},53:{description:"보통 이슬비",icon:"💧",effect:"rain"},55:{description:"강한 이슬비",icon:"💧",effect:"rain"},56:{description:"가벼운 어는 이슬비",icon:"🥶💧",effect:"rain_snow"},57:{description:"강한 어는 이슬비",icon:"🥶💧",effect:"rain_snow"},61:{description:"가벼운 비",icon:"🌧️",effect:"rain"},63:{description:"보통 비",icon:"🌧️",effect:"rain"},65:{description:"강한 비",icon:"🌧️",effect:"rain"},66:{description:"가벼운 어는 비",icon:"🥶🌧️",effect:"rain_snow"},67:{description:"강한 어는 비",icon:"🥶🌧️",effect:"rain_snow"},71:{description:"가벼운 눈",icon:"❄️",effect:"snow"},73:{description:"보통 눈",icon:"❄️",effect:"snow"},75:{description:"강한 눈",icon:"❄️",effect:"snow"},77:{description:"싸락눈",icon:"❄️",effect:"snow"},80:{description:"가벼운 소나기",icon:"🌦️",effect:"rain"},81:{description:"보통 소나기",icon:"🌦️",effect:"rain"},82:{description:"강한 소나기",icon:"⛈️",effect:"rain"},85:{description:"가벼운 눈 소나기",icon:"🌨️",effect:"snow"},86:{description:"강한 눈 소나기",icon:"🌨️",effect:"snow"},95:{description:"천둥번개",icon:"⛈️",effect:"rain"},96:{description:"가벼운 우박 동반 뇌우",icon:"⛈️🧊",effect:"rain"},99:{description:"강한 우박 동반 뇌우",icon:"⛈️🧊",effect:"rain"}}; return wmoMap[wmoCode]||{description:`코드 ${wmoCode}`,icon:"❓",effect:null}; }
    function formatTime(dateString, includeSeconds = false) { /* ... (이전과 동일) ... */ if (!dateString) return "N/A"; try { const date = new Date(dateString); const options = { hour: '2-digit', minute: '2-digit', hour12: false }; if (includeSeconds) options.second = '2-digit'; return date.toLocaleTimeString('ko-KR', options); } catch (e) { return "N/A"; } }
    function degreesToCardinal(deg) { /* ... (이전과 동일) ... */ if (typeof deg !== 'number' || isNaN(deg)) return "N/A"; const cardinals = ["북", "북북동", "북동", "동북동", "동", "동남동", "남동", "남남동", "남", "남남서", "남서", "서남서", "서", "서북서", "북서", "북북서"]; return cardinals[Math.round(deg / 22.5) % 16]; }
    function getAqiDetails(aqiValue) { /* ... (이전과 동일, 현재 호출 안됨) ... */ if(aqiValue===null||isNaN(aqiValue))return{level:"정보 없음",color:"var(--secondary-text-color)"};if(aqiValue<=50)return{level:"좋음",color:"#4CAF50"};if(aqiValue<=100)return{level:"보통",color:"#FFEB3B"};if(aqiValue<=150)return{level:"민감군 주의",color:"#FF9800"};if(aqiValue<=200)return{level:"나쁨",color:"#F44336"};if(aqiValue<=300)return{level:"매우 나쁨",color:"#9C27B0"};return{level:"위험",color:"#795548"}; }

    async function fetchWeather() {
        loadingSkeleton.style.display = 'block';
        appContainer.style.display = 'none';
        errorMessage.style.display = 'none';
        if (aqiSectionEl) aqiSectionEl.style.display = 'none';

        const dailyParams = [ "weather_code", "temperature_2m_max", "temperature_2m_min", "apparent_temperature_max", "apparent_temperature_min", "sunrise", "sunset", "precipitation_sum", "rain_sum", "showers_sum", "snowfall_sum", "precipitation_hours", "precipitation_probability_max", "wind_speed_10m_max", "wind_gusts_10m_max", "wind_direction_10m_dominant", "uv_index_max" ].join(',');
        const hourlyParams = [ "temperature_2m", "apparent_temperature", "relative_humidity_2m", "precipitation_probability", "precipitation", "weather_code", "is_day" ].join(',');

        const forecastUrl = `https://api.open-meteo.com/v1/forecast?latitude=${SEOUL_LAT}&longitude=${SEOUL_LON}&current_weather=true&daily=${dailyParams}&hourly=${hourlyParams}&timezone=Asia/Seoul&forecast_days=7`;
        
        try {
            const response = await fetch(forecastUrl);
            if (!response.ok) { let errorData = { message: response.statusText }; try { errorData = await response.json(); } catch (e) {} throw new Error(`HTTP ${response.status}: ${errorData.reason || errorData.message || response.statusText}`); }
            const data = await response.json();

            if (!data || !data.current_weather || !data.daily || !data.hourly) { throw new Error("API 응답 데이터 형식이 올바르지 않습니다."); }
            
            appContainer.style.display = 'block';
            loadingSkeleton.style.display = 'none';

            document.getElementById('mainTitle').textContent = `☀️ 오늘의 날씨 - 서울 🌸`;
            document.getElementById('subTitle').textContent = `대한민국 서울의 상세한 날씨 정보를 확인하세요.`;

            displayCurrentWeather(data.current_weather, data.hourly, data.timezone_abbreviation);
            
            // AQI 기능은 현재 비활성화
            // if (data.hourly && data.hourly.us_aqi && aqiSectionEl) { aqiSectionEl.style.display = 'block'; displayAqi(data.hourly, data.current_weather.time); } 
            // else if (aqiSectionEl) { aqiSectionEl.style.display = 'none'; }

            displayWeeklyTempChart(data.daily);
            displayForecast(data.daily, data.hourly, data.timezone_abbreviation);
            
            const currentWeatherCode = data.current_weather.weathercode;
            const details = getWeatherDetails(currentWeatherCode, data.current_weather.is_day === 1);
            startWeatherEffect(details.effect);
            
            const currentWeatherIconEl = document.getElementById('currentWeatherIcon');
            if (currentWeatherIconEl) { if (details.icon.includes('☀️')) { currentWeatherIconEl.classList.add('sun'); } else { currentWeatherIconEl.classList.remove('sun'); } }

        } catch (error) {
            console.error('Error fetching weather data:', error);
            loadingSkeleton.style.display = 'none';
            errorMessage.style.display = 'block';
            const displayUrl = forecastUrl.length > 200 ? forecastUrl.substring(0, 200) + "..." : forecastUrl;
            errorMessage.innerHTML = `<span>⚠️</span>날씨 정보 로드 실패: ${error.message}. <br> <a href="${forecastUrl}" target="_blank" style="color: var(--accent-color); word-break:break-all;">API 요청 URL 확인 (${displayUrl})</a>`;
        }
    }
    
    function displayCurrentWeather(current, hourly, timezone) { /* ... (이전과 동일) ... */ if (!current) { console.warn("Current weather data is missing."); return; } const weatherDetails = getWeatherDetails(current.weathercode, current.is_day === 1); document.getElementById('currentWeatherIcon').textContent = weatherDetails.icon; document.getElementById('currentTemp').innerHTML = `${Math.round(current.temperature)}&deg;C`; document.getElementById('currentWeatherDesc').textContent = weatherDetails.description; document.getElementById('currentWindSpeed').innerHTML = `${current.windspeed !== undefined && current.windspeed !== null ? current.windspeed.toFixed(1) : 'N/A'} km/h`; document.getElementById('currentWindDir').textContent = degreesToCardinal(current.winddirection); document.getElementById('currentTime').textContent = `${formatTime(current.time)} (${timezone || 'KST'})`; if (hourly && hourly.time && hourly.time.length > 0) { const now = new Date(current.time); let closestTimeIndex = -1; let minDiff = Infinity; hourly.time.forEach((timeStr, index) => { const hourlyTime = new Date(timeStr); const diff = Math.abs(hourlyTime - now); if (diff < minDiff) { minDiff = diff; closestTimeIndex = index; } }); if (closestTimeIndex !== -1) { document.getElementById('currentApparentTemp').innerHTML = (hourly.apparent_temperature && hourly.apparent_temperature[closestTimeIndex] !== null) ? `${Math.round(hourly.apparent_temperature[closestTimeIndex])}&deg;C` : 'N/A'; document.getElementById('currentHumidity').innerHTML = (hourly.relative_humidity_2m && hourly.relative_humidity_2m[closestTimeIndex] !== null) ? `${hourly.relative_humidity_2m[closestTimeIndex]}%` : 'N/A'; document.getElementById('currentPrecipitation').innerHTML = (hourly.precipitation && hourly.precipitation[closestTimeIndex] !== null) ? `${hourly.precipitation[closestTimeIndex].toFixed(1)} mm` : '0 mm'; } else { document.getElementById('currentApparentTemp').textContent = 'N/A'; document.getElementById('currentHumidity').textContent = 'N/A'; document.getElementById('currentPrecipitation').textContent = '0 mm'; } } else { document.getElementById('currentApparentTemp').textContent = 'N/A'; document.getElementById('currentHumidity').textContent = 'N/A'; document.getElementById('currentPrecipitation').textContent = '0 mm'; } }
    // function displayAqi(hourly, currentTimeStr) { /* AQI 기능 비활성화 */ }

    function displayWeeklyTempChart(daily) {
        // ... (이전과 동일, Chart.js 옵션에서 텍스트 색상 변경 확인)
        if (!daily || !daily.time || daily.time.length === 0) return;
        const labels = daily.time.map(dateStr => { const date = new Date(dateStr); return date.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' }); });
        const tempMaxData = daily.temperature_2m_max;
        const tempMinData = daily.temperature_2m_min;
        const ctxChart = document.getElementById('weeklyTempChart').getContext('2d');
        if (weeklyTempChartInstance) { weeklyTempChartInstance.destroy(); }
        weeklyTempChartInstance = new Chart(ctxChart, {
            type: 'line',
            data: { labels: labels, datasets: [ { label: '최고 기온', data: tempMaxData, borderColor: getComputedStyle(document.documentElement).getPropertyValue('--accent-color-warm').trim(), backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--accent-color-warm').trim().replace(')', ', 0.2)'), tension: 0.3, fill: false, borderWidth: 2 }, { label: '최저 기온', data: tempMinData, borderColor: getComputedStyle(document.documentElement).getPropertyValue('--accent-color-cold').trim(), backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--accent-color-cold').trim().replace(')', ', 0.2)'), tension: 0.3, fill: false, borderWidth: 2 } ] },
            options: { 
                responsive: true, maintainAspectRatio: false, 
                scales: { y: { beginAtZero: false, ticks: { color: 'var(--primary-text-color)', font: {size: 12}, callback: function(value) { return value + '°C';} }, grid: { color: 'var(--border-color)' } }, x: { ticks: { color: 'var(--primary-text-color)', font: {size: 12}}, grid: { display: false } } }, 
                plugins: { legend: { labels: { color: 'var(--primary-text-color)', font: {size: 13}} }, tooltip: { titleColor: 'var(--primary-text-color)', bodyColor: 'var(--primary-text-color)', backgroundColor: 'var(--card-bg-color)', borderColor: 'var(--border-color)', borderWidth: 1, callbacks: { label: function(context) { return `${context.dataset.label}: ${context.parsed.y}°C`; } } } } 
            }
        });
    }

    function displayForecast(daily, hourlyFullData, timezone) {
        console.log("Displaying forecast cards..."); // 함수 시작 로그 확인
        forecastContainer.innerHTML = '';
        if (!daily || !daily.time || daily.time.length === 0) {
            console.warn("Daily forecast data is missing or empty for displayForecast.");
            return; 
        }
        console.log("Daily data for forecast:", daily); // 데이터 확인

        daily.time.forEach((dateStr, i) => {
            console.log("Processing card for:", dateStr, "Index:", i); // 각 카드 처리 로그
            try { 
                const dateObj = new Date(dateStr + "T00:00:00");
                const dayName = dateObj.toLocaleDateString('ko-KR', { weekday: 'long' });
                const today = new Date(); today.setHours(0,0,0,0);
                const tomorrow = new Date(today); tomorrow.setDate(today.getDate() + 1);
                
                let displayDayName = dayName;
                if (dateObj.getTime() === today.getTime()) displayDayName = "📅 오늘";
                else if (dateObj.getTime() === tomorrow.getTime()) displayDayName = "🗓️ 내일";

                const monthDay = dateObj.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' });
                const weatherCode = daily.weather_code && daily.weather_code[i] !== null ? daily.weather_code[i] : 0; 
                const weatherDetails = getWeatherDetails(weatherCode, true);

                const card = document.createElement('div');
                card.classList.add('weather-card');
                // CSS에서 nth-child로 animation-delay를 주므로 JS에서 제거
                // card.style.animationDelay = `${0.15 + i * 0.1}s`; 

                card.addEventListener('click', () => openHourlyModal(dateStr, hourlyFullData, displayDayName, monthDay));
                
                let precipitationTypeText = "";
                if (daily.rain_sum && daily.rain_sum[i] !== null && daily.rain_sum[i] > 0) precipitationTypeText += "비 ";
                if (daily.showers_sum && daily.showers_sum[i] !== null && daily.showers_sum[i] > 0) precipitationTypeText += "소나기 ";
                if (daily.snowfall_sum && daily.snowfall_sum[i] !== null && daily.snowfall_sum[i] > 0) precipitationTypeText += "눈 ";
                if (precipitationTypeText === "") precipitationTypeText = "없음";

                const tempMin = daily.temperature_2m_min && daily.temperature_2m_min[i] !== null ? Math.round(daily.temperature_2m_min[i]) : 'N/A';
                const tempMax = daily.temperature_2m_max && daily.temperature_2m_max[i] !== null ? Math.round(daily.temperature_2m_max[i]) : 'N/A';
                const apparentMin = daily.apparent_temperature_min && daily.apparent_temperature_min[i] !== null ? Math.round(daily.apparent_temperature_min[i]) : 'N/A';
                const apparentMax = daily.apparent_temperature_max && daily.apparent_temperature_max[i] !== null ? Math.round(daily.apparent_temperature_max[i]) : 'N/A';
                const precipSum = daily.precipitation_sum && daily.precipitation_sum[i] !== null ? daily.precipitation_sum[i].toFixed(1) : 'N/A';
                const precipProbMax = daily.precipitation_probability_max && daily.precipitation_probability_max[i] !== null ? daily.precipitation_probability_max[i] : 'N/A';
                const windMax = daily.wind_speed_10m_max && daily.wind_speed_10m_max[i] !== null ? daily.wind_speed_10m_max[i].toFixed(1) : 'N/A';
                const windDir = degreesToCardinal(daily.wind_direction_10m_dominant ? daily.wind_direction_10m_dominant[i] : null);
                const uvMax = daily.uv_index_max && daily.uv_index_max[i] !== null ? daily.uv_index_max[i].toFixed(1) : 'N/A';
                const sunriseTime = formatTime(daily.sunrise ? daily.sunrise[i] : null);
                const sunsetTime = formatTime(daily.sunset ? daily.sunset[i] : null);
                const precipHours = daily.precipitation_hours && daily.precipitation_hours[i] !== null ? daily.precipitation_hours[i].toFixed(0) : 'N/A';

                card.innerHTML = `
                    <div class="card-header">
                        <span class="day-name">${displayDayName}</span>
                        <span class="month-day">${monthDay}</span>
                    </div>
                    <div class="card-main-weather">
                        <span class="icon">${weatherDetails.icon}</span>
                        <div class="temps">
                            <div class="temp-range">
                                <span class="temp-min">${tempMin}&deg;</span> / 
                                <span class="temp-max">${tempMax}&deg;</span>
                            </div>
                            <div class="weather-description">${weatherDetails.description}</div>
                        </div>
                    </div>
                    <div class="card-details-grid">
                        <div class="detail-item feels-like">
                            <span class="label">체감</span>
                            <span class="value">${apparentMin}&deg; / ${apparentMax}&deg;</span>
                        </div>
                        <div class="detail-item precipitation">
                            <span class="label">강수 (${precipitationTypeText.trim()})</span>
                            <span class="value">${precipSum}<span class="unit">mm</span> (${precipProbMax}%)</span>
                        </div>
                        <div class="detail-item wind">
                            <span class="label">바람</span>
                            <span class="value">${windMax}<span class="unit">km/h</span> (${windDir})</span>
                        </div>
                        <div class="detail-item uv-index">
                            <span class="label">자외선</span>
                            <span class="value">${uvMax}</span>
                        </div>
                        <div class="detail-item sunrise-sunset">
                            <span class="label">일출/일몰</span>
                            <span class="value">${sunriseTime} / ${sunsetTime}</span>
                        </div>
                        <div class="detail-item precipitation-hours">
                            <span class="label">강수 시간</span>
                            <span class="value">${precipHours}<span class="unit">시간</span></span>
                        </div>
                    </div>
                `;
                // ⭐ 생성된 카드를 forecastContainer에 추가하는지 확인
                if (forecastContainer) {
                    forecastContainer.appendChild(card);
                } else {
                    console.error("Forecast container not found!");
                }

            } catch (error) {
                console.error("Error creating forecast card for:", dateStr, error); 
            }
        });
        console.log("Finished adding forecast cards."); // 함수 종료 로그
    }

    function openHourlyModal(dateStr, hourlyFullData, dayName, monthDay) {
        // ... (이전과 동일, 차트 옵션 텍스트 색상 확인)
        modalTitle.textContent = `${dayName.replace(/📅|🗓️/g, '').trim()} (${monthDay}) 시간별 예보`; hourlyForecastList.innerHTML = '';
        const selectedDate = dateStr.split('T')[0]; const hourlyLabels = []; const hourlyTemps = []; const hourlyPrecipProbs = [];
        if (hourlyFullData && hourlyFullData.time) {
            hourlyFullData.time.forEach((time, index) => {
                if (time.startsWith(selectedDate)) {
                    const weatherCode = hourlyFullData.weather_code ? hourlyFullData.weather_code[index] : 0; const isDay = hourlyFullData.is_day ? hourlyFullData.is_day[index] === 1 : true; const weatherDetails = getWeatherDetails(weatherCode, isDay);
                    const temp = (hourlyFullData.temperature_2m && hourlyFullData.temperature_2m[index] !== null) ? Math.round(hourlyFullData.temperature_2m[index]) : 'N/A'; const precipProb = (hourlyFullData.precipitation_probability && hourlyFullData.precipitation_probability[index] !== null) ? hourlyFullData.precipitation_probability[index] : 'N/A';
                    const item = document.createElement('div'); item.classList.add('hourly-item'); item.innerHTML = ` <span class="time">${formatTime(time)}</span> <span class="icon">${weatherDetails.icon}</span> <span class="temp">${temp}&deg;C</span> <span class="precip">${precipProb}%</span> <span class="desc">${weatherDetails.description}</span> `; hourlyForecastList.appendChild(item);
                    hourlyLabels.push(new Date(time)); hourlyTemps.push(hourlyFullData.temperature_2m ? hourlyFullData.temperature_2m[index] : null); hourlyPrecipProbs.push(hourlyFullData.precipitation_probability ? hourlyFullData.precipitation_probability[index] : null);
                }
            });
        } else { hourlyForecastList.innerHTML = "<div>시간별 예보 데이터가 없습니다.</div>"; }
        const hourlyCtx = document.getElementById('hourlyTempChart').getContext('2d'); if (hourlyTempChartInstance) { hourlyTempChartInstance.destroy(); }
        hourlyTempChartInstance = new Chart(hourlyCtx, {
            type: 'line',
            data: { labels: hourlyLabels, datasets: [ { label: '온도 (°C)', data: hourlyTemps, borderColor: 'var(--accent-color-warm)', backgroundColor: 'var(--accent-color-warm)', yAxisID: 'yTemp', tension: 0.3, fill: false, borderWidth: 2 }, { label: '강수 확률 (%)', data: hourlyPrecipProbs, borderColor: 'var(--accent-color)', backgroundColor: 'var(--accent-color)', yAxisID: 'yPrecip', tension: 0.3, fill: false, stepped: true, borderWidth: 2 } ] },
            options: { 
                responsive: true, maintainAspectRatio: false,
                scales: { x: { type: 'time', time: { unit: 'hour', tooltipFormat: 'HH:mm', displayFormats: { hour: 'HH:mm'}}, ticks: { color: 'var(--primary-text-color)', font: {size: 11}}, grid: { display: false } }, yTemp: { type: 'linear', position: 'left', title: { display: true, text: '온도 (°C)', color: 'var(--primary-text-color)', font: {size: 12, weight: '500'}}, ticks: { color: 'var(--primary-text-color)', font: {size: 11}, callback: function(value) { return value + '°C';}}, grid: { color: 'var(--border-color)' } }, yPrecip: { type: 'linear', position: 'right', min: 0, max: 100, title: { display: true, text: '강수 확률 (%)', color: 'var(--primary-text-color)', font: {size: 12, weight: '500'}}, ticks: { color: 'var(--primary-text-color)', font: {size: 11}, callback: function(value) { return value + '%';}}, grid: { drawOnChartArea: false } } }, 
                plugins: { legend: { labels: { color: 'var(--primary-text-color)', font: {size: 13}} }, tooltip: { titleColor: 'var(--primary-text-color)', bodyColor: 'var(--primary-text-color)', backgroundColor: 'var(--card-bg-color)', borderColor: 'var(--border-color)', borderWidth: 1, padding: 10 } }, 
                interaction: { mode: 'nearest', axis: 'x', intersect: false } 
            }
        });
        hourlyModal.classList.add('active');
    }

    closeModalButton.onclick = function() { hourlyModal.classList.remove('active'); }
    window.onclick = function(event) { if (event.target == hourlyModal) { hourlyModal.classList.remove('active'); } }

    // 날씨 효과 함수들 (setupCanvas, Particle, draw, update, createParticles, animateParticles, startWeatherEffect)
    function setupCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    function Particle(type) { this.type = type; this.x = Math.random() * canvas.width; if (type === 'snow') { this.y = Math.random() * canvas.height; this.radius = Math.random() * 3 + 1; this.speedY = Math.random() * 1 + 0.5; this.speedX = Math.random() * 1 - 0.5; this.opacity = Math.random() * 0.5 + 0.5; } else if (type === 'rain') { this.y = Math.random() * -canvas.height; this.length = Math.random() * 20 + 10; this.speedY = Math.random() * 10 + 10; this.opacity = Math.random() * 0.3 + 0.2; } }
    Particle.prototype.draw = function() { ctx.beginPath(); ctx.globalAlpha = this.opacity; if (this.type === 'snow') { ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--snow-color').trim(); ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2); ctx.fill(); } else if (type === 'rain') { ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--rain-color').trim(); ctx.lineWidth = 1.5; ctx.moveTo(this.x, this.y); ctx.lineTo(this.x, this.y + this.length); ctx.stroke(); } ctx.globalAlpha = 1; };
    Particle.prototype.update = function() { this.y += this.speedY; if (this.type === 'snow') { this.x += this.speedX; if (this.y > canvas.height + this.radius) { this.y = -this.radius; this.x = Math.random() * canvas.width; } if (this.x > canvas.width + this.radius || this.x < -this.radius) { this.x = Math.random() * canvas.width; this.y = -this.radius; } } else if (type === 'rain') { if (this.y > canvas.height) { this.y = Math.random() * -50; this.x = Math.random() * canvas.width; } } };
    function createParticles(effectType) { particles = []; let numberOfParticles; if (effectType === 'snow') { numberOfParticles = Math.floor(canvas.width * canvas.height / 25000); } else if (effectType === 'rain' || effectType === 'rain_snow') { numberOfParticles = Math.floor(canvas.width * canvas.height / 18000); } else { return; } numberOfParticles = Math.min(numberOfParticles, 250); for (let i = 0; i < numberOfParticles; i++) { let particleType = effectType; if (effectType === 'rain_snow') { particleType = Math.random() > 0.5 ? 'rain' : 'snow'; } particles.push(new Particle(particleType)); } }
    function animateParticles() { ctx.clearRect(0, 0, canvas.width, canvas.height); particles.forEach(p => { p.update(); p.draw(); }); animationFrameId = requestAnimationFrame(animateParticles); }
    function startWeatherEffect(effectType) { if (animationFrameId) { cancelAnimationFrame(animationFrameId); } currentEffectType = effectType; particles = []; ctx.clearRect(0, 0, canvas.width, canvas.height); if (effectType) { createParticles(effectType); if (particles.length > 0) { animateParticles(); } } }
    
    window.addEventListener('resize', () => { setupCanvas(); if (currentEffectType) { startWeatherEffect(currentEffectType); } });

    setupCanvas();
    fetchWeather();
</script>
</body>
</html>