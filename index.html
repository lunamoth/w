<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ïò§ÎäòÏùò ÎÇ†Ïî®</title>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <style>
        :root {
            /* ÎùºÏù¥Ìä∏ Î™®Îìú ÏÉâÏÉÅ Î≥ÄÏàò */
            --bg-color: #f4f7f6;
            --card-bg-color: #ffffff;
            --border-color: #e0e0e0;
            --primary-text-color: #2c3e50;
            --secondary-text-color: #7f8c8d;
            --accent-color: #3498db;
            --accent-color-warm: #e67e22;
            --accent-color-cold: #3498db;
            --rain-color: #3498db;
            --snow-color: #5dade2;
            --font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --skeleton-bg: #e9ecef;
            --skeleton-shine: rgba(0, 0, 0, 0.04);
            --shadow-color: rgba(0, 0, 0, 0.08);
            --button-bg-color: #e9ecef;
            --button-text-color: #2c3e50;
            --button-hover-bg-color: #d1d8dd;
            --spacing-unit: 8px; /* 8px Í∑∏Î¶¨Îìú ÏãúÏä§ÌÖú Í∏∞Ï§Ä Îã®ÏúÑ */
        }

        /* Îã§ÌÅ¨ Î™®Îìú ÏÉâÏÉÅ Î≥ÄÏàò */
        :root[data-theme="dark"] {
            --bg-color: #2c3e50;
            --card-bg-color: #34495e;
            --border-color: #4a6278;
            --primary-text-color: #ecf0f1;
            --secondary-text-color: #95a5a6; /* Slightly lighter for better contrast */
            --accent-color: #5dade2; /* ÏïΩÍ∞Ñ Î∞ùÏùÄ ÌååÎûë */
            --accent-color-warm: #f39c12; /* ÏïΩÍ∞Ñ Î∞ùÏùÄ Ï£ºÌô© */
            --accent-color-cold: #5dade2;
            --rain-color: #5dade2;
            --snow-color: #a9cce3; /* ÏïΩÍ∞Ñ Î∞ùÏùÄ Îàà ÏÉâÏÉÅ */
            --skeleton-bg: #3b5368;
            --skeleton-shine: rgba(255, 255, 255, 0.04);
            --shadow-color: rgba(0, 0, 0, 0.2);
            --button-bg-color: #4a6278;
            --button-text-color: #ecf0f1;
            --button-hover-bg-color: #5f7a93;
        }


        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--primary-text-color);
            margin: 0;
            padding: calc(var(--spacing-unit) * 3); /* 24px */
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
            opacity: 0;
            animation: fadeInPage 0.8s 0.2s ease-out forwards;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        @keyframes fadeInPage {
            to { opacity: 1; }
        }

        .theme-toggle-button {
            position: fixed;
            top: calc(var(--spacing-unit) * 2.5); /* 20px */
            right: calc(var(--spacing-unit) * 2.5); /* 20px */
            padding: var(--spacing-unit) calc(var(--spacing-unit) * 2); /* 8px 16px */
            background-color: var(--button-bg-color);
            color: var(--button-text-color);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            z-index: 1001; /* Î™®Îã¨Î≥¥Îã§ ÏúÑÏóê ÏûàÎèÑÎ°ù */
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .theme-toggle-button:hover {
            background-color: var(--button-hover-bg-color);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }


        canvas#weather-effects-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1; pointer-events: none;
        }

        .cloud-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -2; pointer-events: none; overflow: hidden;
            opacity: 0.5;
        }
        .cloud {
            position: absolute;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 100 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M77.5,60 C77.5,60 77.5,60 77.53,60 C81.03,60 84.19,58.82 86.65,56.78 C92.03,52.28 93.19,44.54 89.44,38.46 C89.07,37.88 88.66,37.33 88.22,36.81 C88.63,36.22 89,35.59 89.3,34.92 C92.8,28.14 90.29,19.91 83.94,15.83 C82.03,14.75 79.88,14.2 77.68,14.2 C76.32,14.2 75,14.42 73.79,14.85 C71.73,10.63 67.03,7.6 61.66,7.6 C55.03,7.6 49.53,11.94 47.87,17.91 C46.07,17.17 44.07,16.8 41.97,16.8 C34.22,16.8 27.92,22.2 27.07,29.67 C26.97,29.67 26.87,29.68 26.78,29.68 C22.03,29.68 18.13,32.81 16.73,37.01 C12.53,38.06 9.63,41.89 9.63,46.4 C9.63,51.93 14.01,56.3 19.53,56.3 L19.53,56.3 L72.38,56.3 C72.38,56.3 72.38,56.3 72.38,56.3S77.5,60 77.5,60Z' fill='%23000' fill-opacity='0.05'/%3E%3C/svg%3E");
            background-repeat: repeat-x;
            background-size: 250px auto;
            width: 300%; height: 120px;
            animation: moveClouds 80s linear infinite;
        }
        .cloud.cloud1 { top: 2%; animation-duration: 90s; }
        .cloud.cloud2 { top: 10%; animation-duration: 70s; animation-delay: -15s; opacity: 0.7; background-size: 300px auto; }
        .cloud.cloud3 { top: 18%; animation-duration: 100s; opacity: 0.8; background-size: 200px auto; }

        @keyframes moveClouds {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100vw); }
        }

        .container { width: 100%; max-width: 1500px; }
        header { text-align: center; margin-bottom: calc(var(--spacing-unit) * 4); position: relative; } /* 32px */
        header h1 { font-size: 3em; font-weight: 300; color: var(--primary-text-color); margin-bottom: var(--spacing-unit); } /* 8px */
        header p { font-size: 1.25em; color: var(--secondary-text-color); }

        /* Ïä§ÏºàÎ†àÌÜ§ UI */
        .skeleton { background-color: var(--skeleton-bg); border-radius: calc(var(--spacing-unit) * 1.25); /* 10px */ position: relative; overflow: hidden; }
        .skeleton::before { background: linear-gradient(to right, transparent 0%, var(--skeleton-shine) 50%, transparent 100%); animation: skeletonShine 1.6s infinite; content: ""; position: absolute; top: 0; left: -150%; width: 100%; height: 100%;}
        @keyframes skeletonShine { 0% { left: -150%; } 100% { left: 150%; } }
        .skeleton-text { height: 1.2em; margin-bottom: calc(var(--spacing-unit) * 0.75); /* 6px */ border-radius: calc(var(--spacing-unit) * 0.5); /* 4px */ }
        .skeleton-icon { width: 5em; height: 5em; border-radius: 50%; margin: 0 auto; }

        .top-info-grid { display: grid; grid-template-columns: 1fr; gap: calc(var(--spacing-unit) * 3); /* 24px */ margin-bottom: calc(var(--spacing-unit) * 4); /* 32px */ }

        .current-weather-section, .aqi-section {
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
            border-radius: calc(var(--spacing-unit) * 2); /* 16px */
            padding: calc(var(--spacing-unit) * 3.5); /* 28px */
            box-shadow: 0 6px 20px var(--shadow-color);
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .current-weather-section h2, .aqi-section h2 {
            font-size: 1.6em; font-weight: 600; color: var(--primary-text-color);
            margin-top: 0; margin-bottom: calc(var(--spacing-unit) * 3); /* 24px */ border-bottom: 1px solid var(--border-color); padding-bottom: calc(var(--spacing-unit) * 1.5); /* 12px */
            display: flex; align-items: center;
            transition: color 0.3s ease, border-color 0.3s ease;
        }
        .current-weather-section h2::before { content: "üå¶Ô∏è"; margin-right: var(--spacing-unit); font-size: 1.2em;} /* 8px */
        .aqi-section h2::before { content: "üå¨Ô∏è"; margin-right: var(--spacing-unit); font-size: 1.2em;} /* 8px */

        .current-weather-main { display: flex; align-items: center; gap: calc(var(--spacing-unit) * 3.5); /* 28px */ margin-bottom: calc(var(--spacing-unit) * 3); /* 24px */ }
        .current-weather-main .icon { font-size: 6em; line-height: 1; filter: drop-shadow(2px 2px 3px rgba(0,0,0,0.1));}
        .current-weather-main .icon.sun { animation: gentleRotate 20s linear infinite paused; animation-play-state: running; }
        @keyframes gentleRotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .current-weather-main .temp-desc .temp { font-size: 4.5em; font-weight: 700; color: var(--primary-text-color); transition: color 0.3s ease;}
        .current-weather-main .temp-desc .desc { font-size: 1.4em; color: var(--secondary-text-color); text-transform: capitalize; margin-top: calc(var(--spacing-unit) * 0.5); /* 4px */ transition: color 0.3s ease;}

        .current-weather-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: calc(var(--spacing-unit) * 2); /* 16px */ }
        .current-weather-details div { color: var(--secondary-text-color); font-size: 1em; background-color: var(--bg-color); padding: var(--spacing-unit) calc(var(--spacing-unit) * 1.5); /* 8px 12px */ border-radius: var(--spacing-unit); /* 8px */ border: 1px solid var(--border-color); transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;}
        .current-weather-details div strong { color: var(--primary-text-color); font-weight: 600; transition: color 0.3s ease;}
        .current-weather-details div::before { margin-right: var(--spacing-unit); } /* 8px */
        .current-weather-details div:nth-child(1)::before { content: "üå°Ô∏è"; } /* Ï≤¥Í∞ê */
        .current-weather-details div:nth-child(2)::before { content: "üíß"; } /* ÏäµÎèÑ */
        .current-weather-details div:nth-child(3)::before { content: "üí®"; } /* ÌíçÏÜç */
        .current-weather-details div:nth-child(4)::before { content: "üß≠"; } /* ÌíçÌñ• */
        .current-weather-details div:nth-child(5)::before { content: "‚òî"; } /* Í∞ïÏàò */
        .current-weather-details div:nth-child(6)::before { content: "‚è∞"; } /* ÏãúÍ∞Ñ */

        .aqi-section { display: none; } /* AQI ÏÑπÏÖòÏùÄ ÌïÑÏöîÏãú ÌëúÏãú */

        .weekly-temp-chart-container {
             background-color: var(--card-bg-color); border: 1px solid var(--border-color);
             border-radius: calc(var(--spacing-unit) * 2); /* 16px */ padding: calc(var(--spacing-unit) * 3); /* 24px */ margin-bottom: calc(var(--spacing-unit) * 4); /* 32px */
             height: 380px;
             position: relative;
             box-shadow: 0 6px 20px var(--shadow-color);
             transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .weekly-temp-chart-container h2 {
            font-size: 1.6em; font-weight: 600; margin-top:0; margin-bottom: calc(var(--spacing-unit) * 2.5); /* 20px */ text-align: center;
            display: flex; align-items: center; justify-content: center;
            color: var(--primary-text-color); transition: color 0.3s ease;
        }
        .weekly-temp-chart-container h2::before { content: "üìä"; margin-right: var(--spacing-unit); font-size: 1.1em;} /* 8px */

        #weeklyTempChart { max-height: calc(100% - 50px); }

        .forecast-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); /* Ïπ¥Îìú ÏµúÏÜå ÎÑàÎπÑ 300px, Í∞ÑÍ≤© Í≥†Î†§ */
            gap: calc(var(--spacing-unit) * 3.5); /* 28px */
            width: 100%;
        }

        .weather-card {
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
            border-radius: calc(var(--spacing-unit) * 2); /* 16px */ padding: calc(var(--spacing-unit) * 3); /* 24px */
            box-shadow: 0 6px 15px var(--shadow-color);
            display: flex; flex-direction: column; gap: calc(var(--spacing-unit) * 2); /* 16px */
            cursor: pointer;
            opacity: 0;
            transform: translateY(25px);
            animation: cardFadeInUp 0.6s ease-out forwards;
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out, background-color 0.3s ease, border-color 0.3s ease;
            will-change: transform, box-shadow; /* ÏµúÏ†ÅÌôî ÌûåÌä∏ */
        }
        .weather-card:nth-child(1) { animation-delay: 0.15s; }
        .weather-card:nth-child(2) { animation-delay: 0.25s; }
        .weather-card:nth-child(3) { animation-delay: 0.35s; }
        /* ... Ïù¥Ìïò animation-delay ÏÉùÎûµ ... */


        @keyframes cardFadeInUp {
            to { opacity: 1; transform: translateY(0); }
        }

        .weather-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.12);
        }
        :root[data-theme="dark"] .weather-card:hover {
            box-shadow: 0 10px 25px rgba(0,0,0,0.25);
        }


        .card-header {
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: calc(var(--spacing-unit) * 1.5); /* 12px */
            transition: border-color 0.3s ease;
            display: flex; /* FlexboxÎ•º ÏÇ¨Ïö©ÌïòÏó¨ ÎÇ†ÏßúÏôÄ ÏöîÏùº Ï†ïÎ†¨ */
            flex-direction: column; /* Í∏∞Î≥∏ ÏàòÏßÅ Ï†ïÎ†¨ Ïú†ÏßÄ */
            align-items: center; /* Ï§ëÏïô Ï†ïÎ†¨ */
        }
        .card-header .date-wrapper { /* ÎÇ†ÏßúÏôÄ ÏöîÏùºÏùÑ Í∞êÏã∏Îäî div */
            display: flex;
            align-items: baseline; /* ÌÖçÏä§Ìä∏ Í∏∞Ï§ÄÏÑ† Ï†ïÎ†¨ */
            gap: calc(var(--spacing-unit) * 0.5); /* 4px, ÎÇ†ÏßúÏôÄ ÏöîÏùº ÏÇ¨Ïù¥ Í∞ÑÍ≤© */
        }
        .card-header .month-day { /* ÎÇ†Ïßú (Ïòà: 00Ïõî 00Ïùº) */
            font-size: 1.5em; /* Í∏∞Ï°¥ ÏöîÏùº ÌÅ¨Í∏∞, Îçî ÌÅ¨Í≤å */
            font-weight: 700;
            color: var(--primary-text-color);
            transition: color 0.3s ease;
        }
        .card-header .day-name { /* ÏöîÏùº (Ïòà: (ÏõîÏöîÏùº)) */
            font-size: 0.95em; /* Í∏∞Ï°¥ ÎÇ†Ïßú ÌÅ¨Í∏∞, Îçî ÏûëÍ≤å */
            color: var(--secondary-text-color);
            transition: color 0.3s ease;
            font-weight: 500;
        }


        .card-main-weather { display: flex; align-items: center; justify-content: space-between; gap: calc(var(--spacing-unit) * 2.5); /* 20px */ }
        .card-main-weather .icon { font-size: 4.5em; animation: gentleBob 3s ease-in-out infinite alternate; filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.08));}
        @keyframes gentleBob { from { transform: translateY(0); } to { transform: translateY(-5px); } }

        .card-main-weather .temps { text-align: right; }
        .card-main-weather .temps .temp-range { font-size: 1.3em; display: block; margin-bottom: calc(var(--spacing-unit) * 0.75); /* 6px */ font-weight: 500; color: var(--primary-text-color); transition: color 0.3s ease;}
        .card-main-weather .temps .temp-min { color: var(--accent-color-cold); font-weight: 700; transition: color 0.3s ease;}
        .card-main-weather .temps .temp-max { color: var(--accent-color-warm); font-weight: 700; transition: color 0.3s ease;}
        .card-main-weather .weather-description { font-size: 1.15em; color: var(--secondary-text-color); text-transform: capitalize; margin-top: calc(var(--spacing-unit) * 0.5); /* 4px */ transition: color 0.3s ease;}

        .card-details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: calc(var(--spacing-unit) * 2); /* 16px */ font-size: 0.95em; }
        .detail-item { background-color: var(--bg-color); padding: calc(var(--spacing-unit) * 1.5); /* 12px */ border-radius: var(--spacing-unit); /* 8px */ border: 1px solid var(--border-color); color: var(--secondary-text-color); display:flex; flex-direction: column; transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;}
        .detail-item .label {
            display: block;
            font-size: 0.85em; /* Slightly smaller */
            opacity: 0.8;    /* Slightly less prominent */
            margin-bottom: calc(var(--spacing-unit) * 0.25); /* 2px */
            color: var(--primary-text-color);
            transition: color 0.3s ease;
        }
        .detail-item .value {
            font-weight: 600;
            font-size: 1em;
            color: var(--primary-text-color);
            transition: color 0.3s ease;
        }
        .detail-item .value .unit { font-size: 0.9em; opacity: 0.8; margin-left: calc(var(--spacing-unit) * 0.5); /* 4px */ }
        .detail-item.feels-like::before { content: "üå°Ô∏è"; margin-right: calc(var(--spacing-unit) * 0.75); /* 6px */ font-size: 0.9em; align-self: flex-start; }
        .detail-item.precipitation::before { content: "üíß"; margin-right: calc(var(--spacing-unit) * 0.75); /* 6px */ font-size: 0.9em; align-self: flex-start; }
        .detail-item.wind::before { content: "üí®"; margin-right: calc(var(--spacing-unit) * 0.75); /* 6px */ font-size: 0.9em; align-self: flex-start; }
        .detail-item.uv-index::before { content: "‚òÄÔ∏è"; margin-right: calc(var(--spacing-unit) * 0.75); /* 6px */ font-size: 0.9em; align-self: flex-start; }
        .detail-item.sunrise-sunset::before { content: "üåÖ"; margin-right: calc(var(--spacing-unit) * 0.75); /* 6px */ font-size: 0.9em; align-self: flex-start; }
        .detail-item.precipitation-hours::before { content: "‚è≥"; margin-right: calc(var(--spacing-unit) * 0.75); /* 6px */ font-size: 0.9em; align-self: flex-start; }

        /* Î™®Îã¨ Ïä§ÌÉÄÏùº */
        .modal {
            display: none; position: fixed; z-index: 1000;
            left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(40, 40, 60, 0.6);
            opacity: 0; transition: opacity 0.3s ease-out;
        }
        :root[data-theme="dark"] .modal {
            background-color: rgba(20, 20, 30, 0.7);
        }
        .modal.active { display: flex; opacity: 1; }
        .modal-content {
            background-color: var(--card-bg-color); color: var(--primary-text-color);
            margin: auto; padding: calc(var(--spacing-unit) * 4); /* 32px */ border: 1px solid var(--border-color);
            border-radius: calc(var(--spacing-unit) * 2); /* 16px */ width: 90%; max-width: 750px;
            box-shadow: 0 12px 35px rgba(0,0,0,0.15);
            transform: scale(0.95); transition: transform 0.3s ease-out, background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
            display: flex; flex-direction: column;
        }
        :root[data-theme="dark"] .modal-content {
            box-shadow: 0 12px 35px rgba(0,0,0,0.3);
        }

        .modal.active .modal-content { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: calc(var(--spacing-unit) * 2); /* 16px */ margin-bottom: calc(var(--spacing-unit) * 3); /* 24px */ flex-shrink: 0; transition: border-color 0.3s ease;}
        .modal-header h2 { font-size: 1.8em; margin: 0; color: var(--primary-text-color); font-weight: 600; transition: color 0.3s ease;}
        .close-button { color: var(--secondary-text-color); font-size: 2.2em; font-weight: bold; cursor: pointer; border:none; background: none; line-height: 1; transition: color 0.3s ease;}
        .close-button:hover, .close-button:focus { color: var(--primary-text-color); }

        /* Î™®Îã¨ ÎÇ¥Î∂Ä ÏàúÏÑú Î≥ÄÍ≤Ω: Ï∞®Ìä∏ -> Î¶¨Ïä§Ìä∏ */
        .hourly-chart-wrapper { /* Ï∞®Ìä∏Í∞Ä Î®ºÏ†Ä Ïò§ÎèÑÎ°ù ÏàúÏÑú Î≥ÄÍ≤Ω ÎåÄÎπÑ */
            height: 320px;
            position: relative;
            flex-shrink: 0;
            margin-bottom: calc(var(--spacing-unit) * 2.5); /* 20px, Ï∞®Ìä∏ÏôÄ Î¶¨Ïä§Ìä∏ ÏÇ¨Ïù¥ Í∞ÑÍ≤© */
        }
        #hourlyTempChart { max-height: 100%; }

        .hourly-forecast-list {
            overflow-y: auto; padding-right: calc(var(--spacing-unit) * 1.5); /* 12px for scrollbar */
            flex-grow: 1;
            min-height: 180px; /* ÏµúÏÜå ÎÜíÏù¥ Ïú†ÏßÄ */
        }

        .hourly-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: calc(var(--spacing-unit) * 1.75) calc(var(--spacing-unit) * 0.75); /* 14px 6px */
            border-bottom: 1px solid var(--border-color);
            transition: border-color 0.3s ease, background-color 0.2s ease;
        }
        .hourly-item:last-child { border-bottom: none; }
        .hourly-item:hover { background-color: rgba(0,0,0,0.03); }
        :root[data-theme="dark"] .hourly-item:hover { background-color: rgba(255,255,255,0.03); }

        .hourly-item .time { font-weight: 600; width: 22%; color: var(--primary-text-color); transition: color 0.3s ease;}
        .hourly-item .icon { font-size: 2em; width: 18%; text-align: center; }
        .hourly-item .temp { width: 20%; text-align: right; font-weight: 500; color: var(--primary-text-color); transition: color 0.3s ease;}
        .hourly-item .precip { width: 25%; text-align: right; font-size: 0.95em; color: var(--secondary-text-color); transition: color 0.3s ease;}
        .hourly-item .desc { width: 15%; text-align: right; font-size: 0.9em; color: var(--secondary-text-color); text-transform: capitalize; transition: color 0.3s ease;}


        #error { font-size: 1.3em; text-align: center; margin-top: calc(var(--spacing-unit) * 6); /* 48px */ width: 100%; color: #c0392b; }
        #error span { font-size: 1.8em; display: block; margin-bottom: var(--spacing-unit); } /* 8px */
        :root[data-theme="dark"] #error { color: #e74c3c; }


        /* Î°úÎî© Ïä§ÏºàÎ†àÌÜ§ */
        #loadingSkeleton { width: 100%; max-width: 1500px; }
        .skeleton-current-weather-section, .skeleton-aqi-section { background-color: var(--card-bg-color); border: 1px solid var(--border-color); border-radius: calc(var(--spacing-unit) * 2); /* 16px */ padding: calc(var(--spacing-unit) * 3.5); /* 28px */ box-shadow: 0 6px 20px var(--shadow-color); transition: background-color 0.3s ease, border-color 0.3s ease; }
        .skeleton-current-weather-main { display: flex; align-items: center; gap: calc(var(--spacing-unit) * 3.5); /* 28px */ margin-bottom: calc(var(--spacing-unit) * 3); /* 24px */ }
        .skeleton-current-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: calc(var(--spacing-unit) * 2); /* 16px */ }
        .skeleton-forecast-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: calc(var(--spacing-unit) * 3.5); /* 28px */ }
        .skeleton-card { background-color: var(--card-bg-color); border: 1px solid var(--border-color); border-radius: calc(var(--spacing-unit) * 2); /* 16px */ padding: calc(var(--spacing-unit) * 3); /* 24px */ transition: background-color 0.3s ease, border-color 0.3s ease;}

        .last-updated-timestamp {
            width: 100%;
            text-align: center;
            margin-top: calc(var(--spacing-unit) * 5); /* 40px */
            padding-bottom: calc(var(--spacing-unit) * 2.5); /* 20px */
            font-size: 0.9em;
            color: var(--secondary-text-color);
            transition: color 0.3s ease;
        }

        /* Added Icon Animations */
        .icon.anim-cloud-drift { animation: cloudDrift 6s ease-in-out infinite alternate; }
        @keyframes cloudDrift {
            from { transform: translateX(-2px) var(--existing-transform, translateY(0)); }
            to { transform: translateX(2px) var(--existing-transform, translateY(0)); }
        }

        .icon.anim-rain-drop { animation: rainDrop 1.2s ease-in-out infinite; }
        @keyframes rainDrop {
            0%, 100% { opacity: 1; transform: translateY(var(--existing-transform-y, 0)) var(--existing-transform-x, translateX(0)); }
            50% { opacity: 0.6; transform: translateY(calc(var(--existing-transform-y, 0px) + 3px)) var(--existing-transform-x, translateX(0));}
        }

        .icon.anim-snow-flake { animation: snowTwirl 5s ease-in-out infinite alternate; }
        @keyframes snowTwirl {
            from { opacity: 0.7; transform: rotate(-7deg) var(--existing-transform, translateY(0)); }
            to { opacity: 1; transform: rotate(7deg) var(--existing-transform, translateY(0)); }
        }
        /* Ensure gentleBob animation is defined if these are to be combined */
        .card-main-weather .icon {
            --existing-transform-y: 0; /* Default for when not bobbing */
        }
        .card-main-weather .icon.gentleBob-active { /* Class to control bobbing with other animations */
            animation: gentleBob 3s ease-in-out infinite alternate;
        }


        @media (max-width: 768px) {
            body { padding: calc(var(--spacing-unit) * 2); /* 16px */ padding-top: calc(var(--spacing-unit) * 8.5); /* 68px ÌÖåÎßà ÌÜ†Í∏Ä Î≤ÑÌäº Í≥µÍ∞Ñ ÌôïÎ≥¥ */}
            .theme-toggle-button { top: calc(var(--spacing-unit) * 2); /* 16px */ right: calc(var(--spacing-unit) * 2); /* 16px */ padding: var(--spacing-unit) calc(var(--spacing-unit) * 1.5); /* 8px 12px */ }
            header h1 { font-size: 2.4em; }
            header p { font-size: 1.1em; }
            .current-weather-main .icon { font-size: 5em; }
            .current-weather-main .temp-desc .temp { font-size: 3.5em; }
            .forecast-container, .skeleton-forecast-container { grid-template-columns: 1fr; gap: calc(var(--spacing-unit) * 3); /* 24px */ }
            .weather-card { padding: calc(var(--spacing-unit) * 2.5); /* 20px */ gap: calc(var(--spacing-unit) * 1.5); /* 12px */ }
            
            .card-header .month-day { font-size: 1.3em; } /* Î™®Î∞îÏùºÏóêÏÑú ÎÇ†Ïßú ÌÅ¨Í∏∞ Ï°∞Ï†ï */
            .card-header .day-name { font-size: 0.9em; }   /* Î™®Î∞îÏùºÏóêÏÑú ÏöîÏùº ÌÅ¨Í∏∞ Ï°∞Ï†ï */

            .modal-content { width: 95%; padding: calc(var(--spacing-unit) * 3); /* 24px */ max-height: 85vh; }
            .hourly-chart-wrapper { height: 250px; margin-bottom: calc(var(--spacing-unit) * 2); /* 16px */ } /* Î™®Î∞îÏùºÏóêÏÑú Ï∞®Ìä∏ ÎÜíÏù¥ Î∞è Í∞ÑÍ≤© Ï°∞Ï†ï */
            .hourly-item .time { width: 25%; }
            .hourly-item .icon { width: 20%; font-size: 1.8em; } /* Î™®Î∞îÏùº ÏïÑÏù¥ÏΩò ÌÅ¨Í∏∞ ÏÇ¥Ïßù Ï§ÑÏûÑ */
            .hourly-item .temp { width: 25%; }
            .hourly-item .precip { display: none; } /* Î™®Î∞îÏùºÏóêÏÑúÎäî Í∞ïÏàòÌôïÎ•† ÌÖçÏä§Ìä∏ Ïà®ÍπÄ */
            .hourly-item .desc { width: 30%; font-size: 0.85em; } /* Î™®Î∞îÏùº ÏÑ§Î™Ö ÌÖçÏä§Ìä∏ ÌÅ¨Í∏∞ Ï°∞Ï†ï */
        }
    </style>
</head>
<body>
    <button id="themeToggle" class="theme-toggle-button">üåô Îã§ÌÅ¨ Î™®Îìú</button>

    <div class="cloud-overlay">
        <div class="cloud cloud1"></div>
        <div class="cloud cloud2"></div>
        <div class="cloud cloud3"></div>
    </div>
    <canvas id="weather-effects-canvas"></canvas>

    <div id="loadingSkeleton">
        <header>
            <div class="skeleton skeleton-text" style="width: 40%; height: 2.8em; margin: 0 auto calc(var(--spacing-unit) * 1);"></div>
            <div class="skeleton skeleton-text" style="width: 60%; height: 1.2em; margin: 0 auto;"></div>
        </header>
        <div class="top-info-grid">
            <section class="skeleton-current-weather-section">
                <div class="skeleton skeleton-text" style="width: 30%; height: 1.4em; margin-bottom: calc(var(--spacing-unit) * 2.5);"></div>
                <div class="skeleton-current-weather-main">
                    <div class="skeleton skeleton-icon" style="width: 5.5em; height: 5.5em;"></div>
                    <div>
                        <div class="skeleton skeleton-text" style="width: 100px; height: 4em;"></div>
                        <div class="skeleton skeleton-text" style="width: 150px; height: 1.3em; margin-top: calc(var(--spacing-unit) * 0.5);"></div>
                    </div>
                </div>
                <div class="skeleton-current-details">
                    <div class="skeleton skeleton-text" style="height: 2.5em;"></div> <div class="skeleton skeleton-text" style="height: 2.5em;"></div>
                    <div class="skeleton skeleton-text" style="height: 2.5em;"></div> <div class="skeleton skeleton-text" style="height: 2.5em;"></div>
                </div>
            </section>
        </div>
        <div class="weekly-temp-chart-container skeleton" style="height: 380px; margin-bottom: calc(var(--spacing-unit) * 4);">
             <div class="skeleton skeleton-text" style="width: 50%; height: 1.6em; margin: 0 auto calc(var(--spacing-unit) * 2.5);"></div>
        </div>
        <main class="skeleton-forecast-container">
            <div class="skeleton-card" style="height: 320px;"></div> <div class="skeleton-card" style="height: 320px;"></div> <div class="skeleton-card" style="height: 320px;"></div>
        </main>
    </div>

    <div class="container" id="appContainer" style="display:none;">
        <header>
            <h1 id="mainTitle">Ïò§ÎäòÍ≥º Ï£ºÍ∞Ñ ÎÇ†Ïî®</h1>
            <p id="subTitle">ÏÑúÏö∏Ïùò ÏÉÅÏÑ∏Ìïú ÎÇ†Ïî® Ï†ïÎ≥¥Î•º ÌôïÏù∏ÌïòÏÑ∏Ïöî.</p>
        </header>

        <div class="top-info-grid">
            <section class="current-weather-section">
                <h2>ÌòÑÏû¨ ÎÇ†Ïî®</h2>
                <div class="current-weather-main">
                    <span class="icon" id="currentWeatherIcon"></span>
                    <div class="temp-desc">
                        <span class="temp" id="currentTemp"></span>
                        <span class="desc" id="currentWeatherDesc"></span>
                    </div>
                </div>
                <div class="current-weather-details">
                    <div>Ï≤¥Í∞ê: <strong id="currentApparentTemp"></strong></div>
                    <div>ÏäµÎèÑ: <strong id="currentHumidity"></strong></div>
                    <div>ÌíçÏÜç: <strong id="currentWindSpeed"></strong></div>
                    <div>ÌíçÌñ•: <strong id="currentWindDir"></strong></div>
                    <div>Í∞ïÏàò(1h): <strong id="currentPrecipitation"></strong></div>
                    <div>ÏãúÍ∞Ñ: <strong id="currentTime"></strong></div>
                </div>
            </section>
             <section class="aqi-section" id="aqiSection" style="display: none;">
                 <h2>ÎåÄÍ∏∞ Ïßà ÏßÄÏàò (AQI)</h2>
                 <div class="aqi-details">
                     <div class="aqi-value" id="aqiValue">N/A</div>
                     <div class="aqi-level" id="aqiLevel">Ï†ïÎ≥¥ ÏóÜÏùå</div>
                     <div class="aqi-pollutants">
                         <span>(Ï†ïÎ≥¥ Î°úÎî© Ï§ë...)</span>
                     </div>
                 </div>
             </section>
        </div>

        <section class="weekly-temp-chart-container">
            <h2>Ï£ºÍ∞Ñ ÏµúÍ≥†/ÏµúÏ†Ä Í∏∞Ïò®</h2>
            <canvas id="weeklyTempChart"></canvas>
        </section>

        <main class="forecast-container" id="forecastContainer">
            <!-- ÎÇ†Ïî® Ïπ¥ÎìúÍ∞Ä Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§. -->
        </main>
    </div>

    <div id="hourlyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">ÏãúÍ∞ÑÎ≥Ñ ÏòàÎ≥¥</h2>
                <span class="close-button" id="closeModalButton">&times;</span>
            </div>
            <div class="hourly-chart-wrapper">
                 <canvas id="hourlyTempChart"></canvas>
            </div>
            <div class="hourly-forecast-list" id="hourlyForecastList">
                <!-- ÏãúÍ∞ÑÎ≥Ñ ÏòàÎ≥¥ ÏïÑÏù¥ÌÖúÏù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§. -->
            </div>
        </div>
    </div>

    <div id="error" style="display:none;"><span>‚ö†Ô∏è</span>ÎÇ†Ïî® Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§. ÎÇòÏ§ëÏóê Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.</div>
    <p id="lastUpdated" class="last-updated-timestamp"></p>

<script>
(function WeatherApp() {
    'use strict';

    // --- CONFIGURATION ---
    const CONFIG = {
        SEOUL_LAT: 37.5665,
        SEOUL_LON: 126.9780,
        API_BASE_URL: "https://api.open-meteo.com/v1/forecast",
        PARTICLE_DENSITY_SNOW_DIVISOR: 25000,
        PARTICLE_DENSITY_RAIN_DIVISOR: 18000,
        MAX_PARTICLES: 250,
        MODAL_ACTIVE_CLASS: 'active',
        LOCAL_STORAGE_THEME_KEY: 'weatherAppTheme',
        WMO_MAP: {0:{description:"ÎßëÏùå",icon:"‚òÄÔ∏è",effect:null},1:{description:"ÎåÄÏ≤¥Î°ú ÎßëÏùå",icon:"üå§Ô∏è",effect:null},2:{description:"Î∂ÄÎ∂ÑÏ†Å ÌùêÎ¶º",icon:"üå•Ô∏è",effect:null},3:{description:"ÌùêÎ¶º",icon:"‚òÅÔ∏è",effect:null},45:{description:"ÏïàÍ∞ú",icon:"üå´Ô∏è",effect:null},48:{description:"ÏÑúÎ¶¨ ÏïàÍ∞ú",icon:"üå´Ô∏è‚ùÑÔ∏è",effect:null},51:{description:"Í∞ÄÎ≤ºÏö¥ Ïù¥Ïä¨ÎπÑ",icon:"üíß",effect:"rain"},53:{description:"Î≥¥ÌÜµ Ïù¥Ïä¨ÎπÑ",icon:"üíß",effect:"rain"},55:{description:"Í∞ïÌïú Ïù¥Ïä¨ÎπÑ",icon:"üíß",effect:"rain"},56:{description:"Í∞ÄÎ≤ºÏö¥ Ïñ¥Îäî Ïù¥Ïä¨ÎπÑ",icon:"ü•∂üíß",effect:"rain_snow"},57:{description:"Í∞ïÌïú Ïñ¥Îäî Ïù¥Ïä¨ÎπÑ",icon:"ü•∂üíß",effect:"rain_snow"},61:{description:"Í∞ÄÎ≤ºÏö¥ ÎπÑ",icon:"üåßÔ∏è",effect:"rain"},63:{description:"Î≥¥ÌÜµ ÎπÑ",icon:"üåßÔ∏è",effect:"rain"},65:{description:"Í∞ïÌïú ÎπÑ",icon:"üåßÔ∏è",effect:"rain"},66:{description:"Í∞ÄÎ≤ºÏö¥ Ïñ¥Îäî ÎπÑ",icon:"ü•∂üåßÔ∏è",effect:"rain_snow"},67:{description:"Í∞ïÌïú Ïñ¥Îäî ÎπÑ",icon:"ü•∂üåßÔ∏è",effect:"rain_snow"},71:{description:"Í∞ÄÎ≤ºÏö¥ Îàà",icon:"‚ùÑÔ∏è",effect:"snow"},73:{description:"Î≥¥ÌÜµ Îàà",icon:"‚ùÑÔ∏è",effect:"snow"},75:{description:"Í∞ïÌïú Îàà",icon:"‚ùÑÔ∏è",effect:"snow"},77:{description:"Ïã∏ÎùΩÎàà",icon:"‚ùÑÔ∏è",effect:"snow"},80:{description:"Í∞ÄÎ≤ºÏö¥ ÏÜåÎÇòÍ∏∞",icon:"üå¶Ô∏è",effect:"rain"},81:{description:"Î≥¥ÌÜµ ÏÜåÎÇòÍ∏∞",icon:"üå¶Ô∏è",effect:"rain"},82:{description:"Í∞ïÌïú ÏÜåÎÇòÍ∏∞",icon:"‚õàÔ∏è",effect:"rain"},85:{description:"Í∞ÄÎ≤ºÏö¥ Îàà ÏÜåÎÇòÍ∏∞",icon:"üå®Ô∏è",effect:"snow"},86:{description:"Í∞ïÌïú Îàà ÏÜåÎÇòÍ∏∞",icon:"üå®Ô∏è",effect:"snow"},95:{description:"Ï≤úÎë•Î≤àÍ∞ú",icon:"‚õàÔ∏è",effect:"rain"},96:{description:"Í∞ÄÎ≤ºÏö¥ Ïö∞Î∞ï ÎèôÎ∞ò ÎáåÏö∞",icon:"‚õàÔ∏èüßä",effect:"rain"},99:{description:"Í∞ïÌïú Ïö∞Î∞ï ÎèôÎ∞ò ÎáåÏö∞",icon:"‚õàÔ∏èüßä",effect:"rain"}}
    };

    const ICON_ANIMATION_MAP = {
        '‚òÄÔ∏è': 'sun',
        '‚òÅÔ∏è': 'anim-cloud-drift',
        'üå•Ô∏è': 'anim-cloud-drift',
        'üå§Ô∏è': 'anim-cloud-drift',
        'üåßÔ∏è': 'anim-rain-drop',
        'üíß': 'anim-rain-drop',
        'üå¶Ô∏è': 'anim-rain-drop',
        '‚õàÔ∏è': 'anim-rain-drop',
        '‚ùÑÔ∏è': 'anim-snow-flake',
        'üå®Ô∏è': 'anim-snow-flake',
    };

    // --- DOM ELEMENT CACHING ---
    const DOM = {
        appContainer: document.getElementById('appContainer'),
        loadingSkeleton: document.getElementById('loadingSkeleton'),
        forecastContainer: document.getElementById('forecastContainer'),
        errorMessage: document.getElementById('error'),
        weatherEffectsCanvas: document.getElementById('weather-effects-canvas'),
        hourlyModal: document.getElementById('hourlyModal'),
        closeModalButton: document.getElementById('closeModalButton'),
        hourlyForecastList: document.getElementById('hourlyForecastList'),
        modalTitle: document.getElementById('modalTitle'),
        aqiSection: document.getElementById('aqiSection'),
        themeToggleButton: document.getElementById('themeToggle'),
        lastUpdated: document.getElementById('lastUpdated'),
        mainTitle: document.getElementById('mainTitle'),
        subTitle: document.getElementById('subTitle'),
        currentWeatherIcon: document.getElementById('currentWeatherIcon'),
        currentTemp: document.getElementById('currentTemp'),
        currentWeatherDesc: document.getElementById('currentWeatherDesc'),
        currentApparentTemp: document.getElementById('currentApparentTemp'),
        currentHumidity: document.getElementById('currentHumidity'),
        currentWindSpeed: document.getElementById('currentWindSpeed'),
        currentWindDir: document.getElementById('currentWindDir'),
        currentPrecipitation: document.getElementById('currentPrecipitation'),
        currentTime: document.getElementById('currentTime'),
        weeklyTempChartCanvas: document.getElementById('weeklyTempChart'),
        hourlyTempChartCanvas: document.getElementById('hourlyTempChart')
    };
    const weatherEffectsCtx = DOM.weatherEffectsCanvas.getContext('2d');

    // --- APP STATE ---
    const _appState = {
        hourlyFullData: null,
        weeklyTempChartInstance: null,
        hourlyTempChartInstance: null,
        weatherEffect: {
            animationFrameId: null,
            particles: [],
            currentEffectType: null
        }
    };

    // --- UTILITY FUNCTIONS ---
    function getWeatherDetails(wmoCode, isDay = true) {
        const details = CONFIG.WMO_MAP[wmoCode];
        if (details) {
            let icon = details.icon;
            if (!isDay) {
                if (wmoCode === 0) icon = "üåô";
                else if (wmoCode === 1) icon = "‚òÅÔ∏èüåô";
            }
            return { ...details, icon };
        }
        return { description: `ÏΩîÎìú ${wmoCode}`, icon: "‚ùì", effect: null };
    }

    function formatTime(dateString, includeSeconds = false) {
        if (!dateString) return "N/A";
        try {
            const date = new Date(dateString);
            const options = { hour: '2-digit', minute: '2-digit', hour12: false };
            if (includeSeconds) options.second = '2-digit';
            return date.toLocaleTimeString('ko-KR', options);
        } catch (e) {
            console.error("Error formatting time:", dateString, e);
            return "N/A";
        }
    }

    function degreesToCardinal(deg) {
        if (typeof deg !== 'number' || isNaN(deg)) return "N/A";
        const cardinals = ["Î∂Å", "Î∂ÅÎ∂ÅÎèô", "Î∂ÅÎèô", "ÎèôÎ∂ÅÎèô", "Îèô", "ÎèôÎÇ®Îèô", "ÎÇ®Îèô", "ÎÇ®ÎÇ®Îèô", "ÎÇ®", "ÎÇ®ÎÇ®ÏÑú", "ÎÇ®ÏÑú", "ÏÑúÎÇ®ÏÑú", "ÏÑú", "ÏÑúÎ∂ÅÏÑú", "Î∂ÅÏÑú", "Î∂ÅÎ∂ÅÏÑú"];
        return cardinals[Math.round(deg / 22.5) % 16];
    }

    function applySpecificIconAnimation(element, iconChar) {
        if (!element) return;

        const classes = Array.from(element.classList);
        for (const cls of classes) {
            if (cls.startsWith('anim-') || cls === 'gentleBob-active' || cls === 'sun') {
                element.classList.remove(cls);
            }
        }
        for (const key in ICON_ANIMATION_MAP) {
            if (iconChar.includes(key)) {
                if (key === 'üå¶Ô∏è' && iconChar.includes('‚õàÔ∏è')) continue;
                element.classList.add(ICON_ANIMATION_MAP[key]);
                if (ICON_ANIMATION_MAP[key] !== 'sun') break; 
            }
        }
    }
    
    // --- THEME MANAGEMENT ---
    function updateChartInstanceColors(chartInstance, newColors, chartType) {
        if (!chartInstance?.options) return;

        chartInstance.options.plugins.legend.labels.color = newColors.primaryTextColor;
        const tooltip = chartInstance.options.plugins.tooltip;
        tooltip.backgroundColor = newColors.cardBgColor;
        tooltip.titleColor = newColors.primaryTextColor;
        tooltip.bodyColor = newColors.primaryTextColor;
        tooltip.borderColor = newColors.borderColor;

        Object.values(chartInstance.options.scales).forEach(axis => {
            if (axis.ticks) axis.ticks.color = newColors.primaryTextColor;
            if (axis.grid) axis.grid.color = newColors.borderColor;
            if (axis.title?.display) axis.title.color = newColors.primaryTextColor;
        });
        
        const ctx = chartInstance.ctx;
        chartInstance.data.datasets.forEach((dataset, index) => {
            let newOpts;
            if (chartType === 'weekly') {
                newOpts = createChartDatasetOptions(index === 0 ? 'weeklyMax' : 'weeklyMin', newColors, ctx, dataset.label, dataset.data);
            } else if (chartType === 'hourly') {
                newOpts = createChartDatasetOptions(index === 0 ? 'hourlyTemp' : 'hourlyPrecip', newColors, ctx, dataset.label, dataset.data);
            }
            if (newOpts) Object.assign(dataset, newOpts);
        });
        chartInstance.update();
    }

    function applyTheme(theme, isInitialLoad = false) {
        document.documentElement.setAttribute('data-theme', theme);
        DOM.themeToggleButton.textContent = theme === 'dark' ? '‚òÄÔ∏è ÎùºÏù¥Ìä∏ Î™®Îìú' : 'üåô Îã§ÌÅ¨ Î™®Îìú';
        localStorage.setItem(CONFIG.LOCAL_STORAGE_THEME_KEY, theme);

        if (!isInitialLoad && (DOM.appContainer.style.display === 'block' || DOM.appContainer.style.display === '')) {
            const newChartColors = getChartColors();
            if (_appState.weeklyTempChartInstance) {
                updateChartInstanceColors(_appState.weeklyTempChartInstance, newChartColors, 'weekly');
            }
            if (_appState.hourlyTempChartInstance) {
                updateChartInstanceColors(_appState.hourlyTempChartInstance, newChartColors, 'hourly');
            }
            if (_appState.weatherEffect.particles.length > 0) {
                updateAllParticleColors();
            }
        }
    }

    function toggleTheme() {
        const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
        applyTheme(currentTheme === 'dark' ? 'light' : 'dark');
    }

    function loadInitialTheme() {
        const savedTheme = localStorage.getItem(CONFIG.LOCAL_STORAGE_THEME_KEY) ||
                           (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        applyTheme(savedTheme, true);
    }

    // --- CHART UTILITIES ---
    function getChartColors() {
        const style = getComputedStyle(document.documentElement);
        return {
            primaryTextColor: style.getPropertyValue('--primary-text-color').trim(),
            borderColor: style.getPropertyValue('--border-color').trim(),
            cardBgColor: style.getPropertyValue('--card-bg-color').trim(),
            accentColorWarm: style.getPropertyValue('--accent-color-warm').trim(),
            accentColorCold: style.getPropertyValue('--accent-color-cold').trim(),
            accentColor: style.getPropertyValue('--accent-color').trim(),
            fontFamily: style.getPropertyValue('--font-family').trim()
        };
    }
    
    function getBaseChartOptions() {
        const colors = getChartColors();
        return {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                legend: { labels: { color: colors.primaryTextColor, font: { size: 13, family: colors.fontFamily }}},
                tooltip: {
                    backgroundColor: colors.cardBgColor, titleColor: colors.primaryTextColor,
                    bodyColor: colors.primaryTextColor, borderColor: colors.borderColor, borderWidth: 1,
                    padding: 10, cornerRadius: 6,
                    titleFont: { weight: 'bold', size: 13, family: colors.fontFamily },
                    bodyFont: { size: 12, family: colors.fontFamily },
                }
            },
            interaction: { mode: 'index', intersect: false },
            scales: {
                x: { ticks: { color: colors.primaryTextColor, font: {size: 11, family: colors.fontFamily}}, grid: { display: false, borderColor: colors.borderColor }},
                y: { ticks: { color: colors.primaryTextColor, font: {size: 11, family: colors.fontFamily}}, grid: { color: colors.borderColor }}
            }
        };
    }

    function createChartGradient(ctx, colorVarName, opacity = 0.2) {
        const gradient = ctx.createLinearGradient(0, 0, 0, ctx.canvas.height);
        const parsedColor = getComputedStyle(document.documentElement).getPropertyValue(colorVarName).trim();
        let r = 0, g = 0, b = 0;

        if (parsedColor.startsWith('#')) {
            r = parseInt(parsedColor.slice(1, 3), 16);
            g = parseInt(parsedColor.slice(3, 5), 16);
            b = parseInt(parsedColor.slice(5, 7), 16);
        } else if (parsedColor.startsWith('rgb')) {
            const match = parsedColor.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*[\d.]+)?\)/);
            if (match) {
                r = parseInt(match[1], 10);
                g = parseInt(match[2], 10);
                b = parseInt(match[3], 10);
            }
        }
        gradient.addColorStop(0, `rgba(${r},${g},${b},${opacity})`);
        gradient.addColorStop(1, `rgba(${r},${g},${b},0)`);
        return gradient;
    }

    function createChartDatasetOptions(type, colors, ctx, label, data) {
        const baseDataset = {
            label, data,
            tension: 0.3, fill: 'start',
            pointBorderColor: colors.cardBgColor,
        };

        switch (type) {
            case 'weeklyMax':
                return {
                    ...baseDataset,
                    borderColor: colors.accentColorWarm, backgroundColor: createChartGradient(ctx, '--accent-color-warm', 0.3),
                    borderWidth: 2.5, pointRadius: 4, pointHoverRadius: 6,
                    pointBackgroundColor: colors.accentColorWarm, pointHoverBorderColor: colors.accentColorWarm, pointBorderWidth: 2
                };
            case 'weeklyMin':
                return {
                    ...baseDataset,
                    borderColor: colors.accentColorCold, backgroundColor: createChartGradient(ctx, '--accent-color-cold', 0.3),
                    borderWidth: 2.5, pointRadius: 4, pointHoverRadius: 6,
                    pointBackgroundColor: colors.accentColorCold, pointHoverBorderColor: colors.accentColorCold, pointBorderWidth: 2
                };
            case 'hourlyTemp':
                return {
                    ...baseDataset, yAxisID: 'yTemp',
                    borderColor: colors.accentColorWarm, backgroundColor: createChartGradient(ctx, '--accent-color-warm', 0.25),
                    borderWidth: 2, pointRadius: 3, pointHoverRadius: 5,
                    pointBackgroundColor: colors.accentColorWarm, pointHoverBorderColor: colors.accentColorWarm, pointBorderWidth: 1.5
                };
            case 'hourlyPrecip':
                return {
                    ...baseDataset, yAxisID: 'yPrecip', stepped: false,
                    borderColor: colors.accentColor, backgroundColor: createChartGradient(ctx, '--accent-color', 0.15),
                    borderWidth: 2, pointRadius: 3, pointHoverRadius: 5,
                    pointBackgroundColor: colors.accentColor, pointHoverBorderColor: colors.accentColor, pointBorderWidth: 1.5
                };
            default: return baseDataset;
        }
    }

    // --- UI RENDERING ---
    function renderSkeleton(show = true) {
        DOM.loadingSkeleton.style.display = show ? 'block' : 'none';
        DOM.appContainer.style.display = show ? 'none' : 'block';
    }

    function renderError(message, url = null) {
        DOM.errorMessage.style.display = 'block';
        let html = `<span>‚ö†Ô∏è</span>${message}`;
        if (url) {
            const displayUrl = url.length > 200 ? `${url.substring(0, 200)}...` : url;
            html += `<br><a href="${url}" target="_blank" style="color: var(--accent-color); word-break:break-all;">API ÏöîÏ≤≠ URL (${displayUrl})</a>`;
        }
        DOM.errorMessage.innerHTML = html;
    }

    function clearError() {
        DOM.errorMessage.style.display = 'none';
        DOM.errorMessage.innerHTML = '';
    }
    
    function renderCurrentWeather(current, hourly, timezone) {
        if (!current) {
            console.warn("Current weather data is missing.");
            DOM.currentWeatherIcon.textContent = 'N/A'; DOM.currentTemp.innerHTML = 'N/A&deg;C';
            DOM.currentWeatherDesc.textContent = 'N/A'; DOM.currentApparentTemp.innerHTML = 'N/A&deg;C';
            DOM.currentHumidity.innerHTML = 'N/A%'; DOM.currentWindSpeed.innerHTML = 'N/A km/h';
            DOM.currentWindDir.textContent = 'N/A'; DOM.currentPrecipitation.innerHTML = 'N/A mm';
            DOM.currentTime.textContent = 'N/A';
            return;
        }

        const weatherDetails = getWeatherDetails(current.weathercode, current.is_day === 1);
        DOM.currentWeatherIcon.textContent = weatherDetails.icon;
        DOM.currentTemp.innerHTML = `${Math.round(current.temperature)}&deg;C`;
        DOM.currentWeatherDesc.textContent = weatherDetails.description;
        DOM.currentWindSpeed.innerHTML = `${current.windspeed?.toFixed(1) ?? 'N/A'} km/h`;
        DOM.currentWindDir.textContent = degreesToCardinal(current.winddirection);
        DOM.currentTime.textContent = `${formatTime(current.time)} (${timezone || 'KST'})`;

        applySpecificIconAnimation(DOM.currentWeatherIcon, weatherDetails.icon);

        if (hourly?.time?.length > 0) {
            const now = new Date(current.time);
            const closestTimeIndex = hourly.time.reduce((closestIdx, timeStr, currentIdx) => {
                const diff = Math.abs(new Date(timeStr) - now);
                const prevDiff = Math.abs(new Date(hourly.time[closestIdx]) - now);
                return diff < prevDiff ? currentIdx : closestIdx;
            }, 0);

            DOM.currentApparentTemp.innerHTML = `${Math.round(hourly.apparent_temperature?.[closestTimeIndex] ?? 'N/A')}&deg;C`;
            DOM.currentHumidity.innerHTML = `${hourly.relative_humidity_2m?.[closestTimeIndex] ?? 'N/A'}%`;
            DOM.currentPrecipitation.innerHTML = `${hourly.precipitation?.[closestTimeIndex]?.toFixed(1) ?? '0'} mm`;
        } else {
            DOM.currentApparentTemp.innerHTML = 'N/A&deg;C';
            DOM.currentHumidity.innerHTML = 'N/A%';
            DOM.currentPrecipitation.innerHTML = '0 mm';
        }
    }

    function renderWeeklyTempChart(dailyData) {
        if (!dailyData?.time?.length) return;

        const labels = dailyData.time.map(dateStr => new Date(dateStr).toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' }));
        const chartColors = getChartColors();
        const baseOptions = getBaseChartOptions();
        const ctx = DOM.weeklyTempChartCanvas.getContext('2d');

        if (_appState.weeklyTempChartInstance) _appState.weeklyTempChartInstance.destroy();
        
        Chart.defaults.color = chartColors.primaryTextColor;
        Chart.defaults.borderColor = chartColors.borderColor;

        _appState.weeklyTempChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels,
                datasets: [
                    createChartDatasetOptions('weeklyMax', chartColors, ctx, 'ÏµúÍ≥† Í∏∞Ïò®', dailyData.temperature_2m_max),
                    createChartDatasetOptions('weeklyMin', chartColors, ctx, 'ÏµúÏ†Ä Í∏∞Ïò®', dailyData.temperature_2m_min)
                ]
            },
            options: {
                ...baseOptions,
                scales: {
                    y: { ...baseOptions.scales.y, beginAtZero: false, ticks: { ...baseOptions.scales.y.ticks, callback: value => `${value}¬∞C` }},
                    x: { ...baseOptions.scales.x, ticks: { ...baseOptions.scales.x.ticks, font: { size: 12 }}}
                },
                plugins: { ...baseOptions.plugins, tooltip: { ...baseOptions.plugins.tooltip, padding: 12, cornerRadius: 8, titleFont: { ...baseOptions.plugins.tooltip.titleFont, size: 14 }, callbacks: { label: context => `${context.dataset.label}: ${context.parsed.y}¬∞C`}}}
            }
        });
    }

    function createForecastCardHTML(dayData, index) {
        const dateObj = new Date(`${dayData.time[index]}T00:00:00`);
        const today = new Date(); today.setHours(0,0,0,0);
        const tomorrow = new Date(today); tomorrow.setDate(today.getDate() + 1);

        const dayNameOriginal = dateObj.toLocaleDateString('ko-KR', { weekday: 'long' });
        let dayNameFormattedForCard = `(${dayNameOriginal})`; // For card display

        if (dateObj.getTime() === today.getTime()) dayNameFormattedForCard = "(Ïò§Îäò)";
        else if (dateObj.getTime() === tomorrow.getTime()) dayNameFormattedForCard = "(ÎÇ¥Ïùº)";

        const monthDay = dateObj.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' });
        const weatherDetails = getWeatherDetails(dayData.weather_code[index], true);

        const tempMin = Math.round(dayData.temperature_2m_min[index]);
        const tempMax = Math.round(dayData.temperature_2m_max[index]);
        const apparentMin = Math.round(dayData.apparent_temperature_min[index]);
        const apparentMax = Math.round(dayData.apparent_temperature_max[index]);
        const precipSum = dayData.precipitation_sum[index].toFixed(1);
        const precipProbMax = dayData.precipitation_probability_max[index];
        const windMax = dayData.wind_speed_10m_max[index].toFixed(1);
        const windDir = degreesToCardinal(dayData.wind_direction_10m_dominant[index]);
        const uvMax = dayData.uv_index_max[index].toFixed(1);
        const sunriseTime = formatTime(dayData.sunrise[index]);
        const sunsetTime = formatTime(dayData.sunset[index]);
        const precipHours = dayData.precipitation_hours[index].toFixed(0);

        let precipType = "";
        if (dayData.rain_sum[index] > 0) precipType += "ÎπÑ ";
        if (dayData.showers_sum[index] > 0) precipType += "ÏÜåÎÇòÍ∏∞ ";
        if (dayData.snowfall_sum[index] > 0) precipType += "Îàà ";
        precipType = precipType.trim() || "ÏóÜÏùå";

        const card = document.createElement('div');
        card.className = 'weather-card';
        card.dataset.dateStr = dayData.time[index];
        card.dataset.dayName = dayNameOriginal; // Store full day name for modal
        card.dataset.monthDay = monthDay;
        
        card.innerHTML = `
            <div class="card-header">
                <div class="date-wrapper">
                    <span class="month-day">${monthDay}</span>
                    <span class="day-name">${dayNameFormattedForCard}</span>
                </div>
            </div>
            <div class="card-main-weather">
                <span class="icon">${weatherDetails.icon}</span>
                <div class="temps">
                    <div class="temp-range">
                        <span class="temp-min">${tempMin}&deg;</span> / <span class="temp-max">${tempMax}&deg;</span>
                    </div>
                    <div class="weather-description">${weatherDetails.description}</div>
                </div>
            </div>
            <div class="card-details-grid">
                <div class="detail-item feels-like"><span class="label">Ï≤¥Í∞ê</span><span class="value">${apparentMin}&deg; / ${apparentMax}&deg;</span></div>
                <div class="detail-item precipitation"><span class="label">Í∞ïÏàò (${precipType})</span><span class="value">${precipSum}<span class="unit">mm</span> (${precipProbMax}%)</span></div>
                <div class="detail-item wind"><span class="label">Î∞îÎûå</span><span class="value">${windMax}<span class="unit">km/h</span> (${windDir})</span></div>
                <div class="detail-item uv-index"><span class="label">ÏûêÏô∏ÏÑ†</span><span class="value">${uvMax}</span></div>
                <div class="detail-item sunrise-sunset"><span class="label">ÏùºÏ∂ú/ÏùºÎ™∞</span><span class="value">${sunriseTime} / ${sunsetTime}</span></div>
                <div class="detail-item precipitation-hours"><span class="label">Í∞ïÏàò ÏãúÍ∞Ñ</span><span class="value">${precipHours}<span class="unit">ÏãúÍ∞Ñ</span></span></div>
            </div>`;
        
        const iconEl = card.querySelector('.card-main-weather .icon');
        if (iconEl) applySpecificIconAnimation(iconEl, weatherDetails.icon);
        return card;
    }

    function renderDailyForecasts(dailyData) {
        DOM.forecastContainer.innerHTML = '';
        if (!dailyData?.time?.length) {
            console.warn("Daily forecast data is missing.");
            return;
        }
        const fragment = document.createDocumentFragment();
        dailyData.time.forEach((_, i) => {
            try {
                fragment.appendChild(createForecastCardHTML(dailyData, i));
            } catch (error) {
                console.error("Error creating forecast card for index:", i, error);
            }
        });
        DOM.forecastContainer.appendChild(fragment);
    }

    function createHourlyForecastItemHTML(hourlyData, index) {
        const weatherDetails = getWeatherDetails(hourlyData.weather_code[index], hourlyData.is_day[index] === 1);
        const temp = Math.round(hourlyData.temperature_2m[index]);
        const precipProb = hourlyData.precipitation_probability[index];
        return `
            <div class="hourly-item">
                <span class="time">${formatTime(hourlyData.time[index])}</span>
                <span class="icon">${weatherDetails.icon}</span>
                <span class="temp">${temp}&deg;C</span>
                <span class="precip">${precipProb}%</span>
                <span class="desc">${weatherDetails.description}</span>
            </div>`;
    }
    
    function renderHourlyDataInModal(dateStr, dayName, monthDay) { // dayName is now always full day name like "ÏùºÏöîÏùº"
        const hourlyFullData = _appState.hourlyFullData;
        if (!hourlyFullData?.time) {
            console.error("Hourly data for modal is not available in app state.");
            DOM.modalTitle.textContent = "Ïò§Î•ò";
            DOM.hourlyForecastList.innerHTML = "<div class='hourly-item'>ÏãúÍ∞ÑÎ≥Ñ ÏòàÎ≥¥ Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</div>";
            if (_appState.hourlyTempChartInstance) { _appState.hourlyTempChartInstance.destroy(); _appState.hourlyTempChartInstance = null; }
            DOM.hourlyTempChartCanvas.getContext('2d').clearRect(0,0,DOM.hourlyTempChartCanvas.width, DOM.hourlyTempChartCanvas.height);
            DOM.hourlyModal.classList.add(CONFIG.MODAL_ACTIVE_CLASS);
            return;
        }

        DOM.modalTitle.textContent = `${monthDay} (${dayName}) ÏãúÍ∞ÑÎ≥Ñ ÏòàÎ≥¥`; // Changed order
        
        const selectedDate = dateStr.split('T')[0];
        const chartLabels = [];
        const chartTemps = [];
        const chartPrecipProbs = [];
        let hourlyItemsHTML = "";

        hourlyFullData.time.forEach((time, index) => {
            if (time.startsWith(selectedDate)) {
                hourlyItemsHTML += createHourlyForecastItemHTML(hourlyFullData, index);
                chartLabels.push(new Date(time));
                chartTemps.push(hourlyFullData.temperature_2m[index]);
                chartPrecipProbs.push(hourlyFullData.precipitation_probability[index]);
            }
        });
        DOM.hourlyForecastList.innerHTML = hourlyItemsHTML;

        const chartColors = getChartColors();
        const baseOptions = getBaseChartOptions();
        const ctx = DOM.hourlyTempChartCanvas.getContext('2d');

        if (_appState.hourlyTempChartInstance) _appState.hourlyTempChartInstance.destroy();
        
        Chart.defaults.color = chartColors.primaryTextColor;
        Chart.defaults.borderColor = chartColors.borderColor;

        _appState.hourlyTempChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartLabels,
                datasets: [
                    createChartDatasetOptions('hourlyTemp', chartColors, ctx, 'Ïò®ÎèÑ (¬∞C)', chartTemps),
                    createChartDatasetOptions('hourlyPrecip', chartColors, ctx, 'Í∞ïÏàò ÌôïÎ•† (%)', chartPrecipProbs)
                ]
            },
            options: {
                ...baseOptions,
                scales: {
                    x: { ...baseOptions.scales.x, type: 'time', time: { unit: 'hour', tooltipFormat: 'HH:mm', displayFormats: { hour: 'HH:mm' }}},
                    yTemp: { ...baseOptions.scales.y, type: 'linear', position: 'left', title: { display: true, text: 'Ïò®ÎèÑ (¬∞C)', color: chartColors.primaryTextColor, font: {size: 12, weight: '500', family: chartColors.fontFamily}}, ticks: { ...baseOptions.scales.y.ticks, callback: value => `${value}¬∞C`}},
                    yPrecip: { ...baseOptions.scales.y, type: 'linear', position: 'right', min: 0, max: 100, title: { display: true, text: 'Í∞ïÏàò ÌôïÎ•† (%)', color: chartColors.primaryTextColor, font: {size: 12, weight: '500', family: chartColors.fontFamily}}, ticks: { ...baseOptions.scales.y.ticks, callback: value => `${value}%`}, grid: { ...baseOptions.scales.y.grid, drawOnChartArea: false }}
                },
                interaction: { mode: 'nearest', axis: 'x', intersect: false }
            }
        });
        DOM.hourlyModal.classList.add(CONFIG.MODAL_ACTIVE_CLASS);
    }

    // --- WEATHER EFFECTS ---
    function setupWeatherEffectsCanvas() {
        DOM.weatherEffectsCanvas.width = window.innerWidth;
        DOM.weatherEffectsCanvas.height = window.innerHeight;
    }

    function Particle(effectType) {
        this.type = effectType;
        this.x = Math.random() * DOM.weatherEffectsCanvas.width;
        if (effectType === 'snow') {
            this.y = Math.random() * DOM.weatherEffectsCanvas.height;
            this.radius = Math.random() * 3 + 1;
            this.speedY = Math.random() * 1 + 0.5;
            this.speedX = Math.random() * 1 - 0.5;
            this.opacity = Math.random() * 0.5 + 0.5;
        } else if (effectType === 'rain') {
            this.y = Math.random() * -DOM.weatherEffectsCanvas.height;
            this.length = Math.random() * 20 + 10;
            this.speedY = Math.random() * 10 + 10;
            this.opacity = Math.random() * 0.3 + 0.2;
        }
        this.setColor();
    }

    Particle.prototype.setColor = function() {
        const style = getComputedStyle(document.documentElement);
        if (this.type === 'snow') this.color = style.getPropertyValue('--snow-color').trim();
        else if (this.type === 'rain') this.color = style.getPropertyValue('--rain-color').trim();
    };

    Particle.prototype.draw = function() {
        weatherEffectsCtx.beginPath();
        weatherEffectsCtx.globalAlpha = this.opacity;
        if (this.type === 'snow') {
            weatherEffectsCtx.fillStyle = this.color;
            weatherEffectsCtx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
            weatherEffectsCtx.fill();
        } else if (this.type === 'rain') {
            weatherEffectsCtx.strokeStyle = this.color;
            weatherEffectsCtx.lineWidth = 1.5;
            weatherEffectsCtx.moveTo(this.x, this.y);
            weatherEffectsCtx.lineTo(this.x, this.y + this.length);
            weatherEffectsCtx.stroke();
        }
        weatherEffectsCtx.globalAlpha = 1;
    };
    Particle.prototype.update = function() {
        this.y += this.speedY;
        const canvas = DOM.weatherEffectsCanvas;
        if (this.type === 'snow') {
            this.x += this.speedX;
            if (this.y > canvas.height + this.radius) { this.y = -this.radius; this.x = Math.random() * canvas.width; }
            if (this.x > canvas.width + this.radius || this.x < -this.radius) { this.x = Math.random() * canvas.width; this.y = -this.radius; }
        } else if (this.type === 'rain') {
            if (this.y > canvas.height) { this.y = Math.random() * -50; this.x = Math.random() * canvas.width; }
        }
    };
    
    function updateAllParticleColors() {
        _appState.weatherEffect.particles.forEach(p => p.setColor());
    }

    function createParticles(effectType) {
        const effect = _appState.weatherEffect;
        effect.particles = [];
        let numParticles;
        const canvasArea = DOM.weatherEffectsCanvas.width * DOM.weatherEffectsCanvas.height;

        if (effectType === 'snow') numParticles = Math.floor(canvasArea / CONFIG.PARTICLE_DENSITY_SNOW_DIVISOR);
        else if (effectType === 'rain' || effectType === 'rain_snow') numParticles = Math.floor(canvasArea / CONFIG.PARTICLE_DENSITY_RAIN_DIVISOR);
        else return;

        numParticles = Math.min(numParticles, CONFIG.MAX_PARTICLES);
        for (let i = 0; i < numParticles; i++) {
            let particleType = (effectType === 'rain_snow') ? (Math.random() > 0.5 ? 'rain' : 'snow') : effectType;
            effect.particles.push(new Particle(particleType));
        }
    }

    function animateParticles() {
        const effect = _appState.weatherEffect;
        weatherEffectsCtx.clearRect(0, 0, DOM.weatherEffectsCanvas.width, DOM.weatherEffectsCanvas.height);
        effect.particles.forEach(p => { p.update(); p.draw(); });
        effect.animationFrameId = requestAnimationFrame(animateParticles);
    }

    function startWeatherEffect(effectType) {
        const effect = _appState.weatherEffect;
        if (effect.animationFrameId) cancelAnimationFrame(effect.animationFrameId);
        
        effect.currentEffectType = effectType;
        effect.particles = [];
        weatherEffectsCtx.clearRect(0, 0, DOM.weatherEffectsCanvas.width, DOM.weatherEffectsCanvas.height);

        if (effectType) {
            createParticles(effectType);
            if (effect.particles.length > 0) animateParticles();
        }
    }
    
    // --- DATA FETCHING AND PROCESSING ---
    async function fetchWeatherData() {
        const dailyP = "weather_code,temperature_2m_max,temperature_2m_min,apparent_temperature_max,apparent_temperature_min,sunrise,sunset,precipitation_sum,rain_sum,showers_sum,snowfall_sum,precipitation_hours,precipitation_probability_max,wind_speed_10m_max,wind_gusts_10m_max,wind_direction_10m_dominant,uv_index_max";
        const hourlyP = "temperature_2m,apparent_temperature,relative_humidity_2m,precipitation_probability,precipitation,weather_code,is_day";
        const url = `${CONFIG.API_BASE_URL}?latitude=${CONFIG.SEOUL_LAT}&longitude=${CONFIG.SEOUL_LON}&current_weather=true&daily=${dailyP}&hourly=${hourlyP}&timezone=Asia/Seoul&forecast_days=7`;

        try {
            const response = await fetch(url);
            if (!response.ok) {
                let errorData = { message: response.statusText, reason: "Unknown error" };
                try { errorData = await response.json(); } catch (e) { /* ignore */ }
                throw new Error(`HTTP ${response.status}: ${errorData.reason || errorData.message}`);
            }
            const data = await response.json();
            if (!data?.current_weather || !data?.daily || !data?.hourly) {
                throw new Error("API ÏùëÎãµ Îç∞Ïù¥ÌÑ∞ ÌòïÏãùÏù¥ Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.");
            }
            return {data, url};
        } catch (error) {
            console.error('Error fetching weather data:', error);
            throw { originalError: error, failedUrl: url };
        }
    }

    function processAndDisplayWeatherData(weatherData) {
        _appState.hourlyFullData = weatherData.hourly;

        DOM.mainTitle.textContent = `Ïò§ÎäòÏùò ÎÇ†Ïî® - ÏÑúÏö∏`;
        DOM.subTitle.textContent = `ÎåÄÌïúÎØºÍµ≠ ÏÑúÏö∏Ïùò ÏÉÅÏÑ∏Ìïú ÎÇ†Ïî® Ï†ïÎ≥¥Î•º ÌôïÏù∏ÌïòÏÑ∏Ïöî.`;

        renderCurrentWeather(weatherData.current_weather, weatherData.hourly, weatherData.timezone_abbreviation);
        renderWeeklyTempChart(weatherData.daily);
        renderDailyForecasts(weatherData.daily);

        const currentWeatherDetails = getWeatherDetails(weatherData.current_weather.weathercode, weatherData.current_weather.is_day === 1);
        startWeatherEffect(currentWeatherDetails.effect);
        
        const now = new Date();
        DOM.lastUpdated.textContent = `ÎßàÏßÄÎßâ ÏóÖÎç∞Ïù¥Ìä∏: ${now.toLocaleDateString('ko-KR')} ${now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit'})}`;
    }

    async function loadWeatherData(showSkeletonUI = true) {
        if (showSkeletonUI) renderSkeleton(true);
        clearError();
        if (DOM.aqiSection) DOM.aqiSection.style.display = 'none';

        try {
            const {data, url} = await fetchWeatherData();
            processAndDisplayWeatherData(data);
            if (showSkeletonUI) renderSkeleton(false);
        } catch (errorInfo) {
            if (showSkeletonUI) renderSkeleton(false);
            renderError(`ÎÇ†Ïî® Ï†ïÎ≥¥ Î°úÎìú Ïã§Ìå®: ${errorInfo.originalError.message}`, errorInfo.failedUrl);
        }
    }
    
    // --- EVENT LISTENERS & INITIALIZATION ---
    function setupEventListeners() {
        DOM.closeModalButton.onclick = () => DOM.hourlyModal.classList.remove(CONFIG.MODAL_ACTIVE_CLASS);
        window.onclick = event => {
            if (event.target === DOM.hourlyModal) DOM.hourlyModal.classList.remove(CONFIG.MODAL_ACTIVE_CLASS);
        };
        window.addEventListener('resize', () => {
            setupWeatherEffectsCanvas();
            if (_appState.weatherEffect.currentEffectType) {
                startWeatherEffect(_appState.weatherEffect.currentEffectType);
            }
        });
        DOM.themeToggleButton.addEventListener('click', toggleTheme);

        DOM.forecastContainer.addEventListener('click', event => {
            const card = event.target.closest('.weather-card');
            if (card?.dataset.dateStr && card.dataset.dayName && card.dataset.monthDay) {
                renderHourlyDataInModal(card.dataset.dateStr, card.dataset.dayName, card.dataset.monthDay);
            }
        });
    }

    function initialize() {
        loadInitialTheme();
        setupWeatherEffectsCanvas();
        setupEventListeners();
        loadWeatherData();
    }

    // --- START THE APP ---
    initialize();

})();
</script>
</body>
</html>
